 結合 。 引き続き SQL について 学習 し ます 。 複数 の 表 や ビュー から データ を 連結 し て 取り出す 操作 で ある 結合 を 学習 し ます 。 内部 結合 。 内部 結合 （ INNER JOIN ） は 、 2 表 に対して 結合 を 行い 、 結合 条件 に 一致 する 行 だけ を 取り出し ます 。 内部 結合 は 、 内 結合 とも いい ます 。 A 表 の Y 列 と B 表 の Y 列 の 値 が 等しい こと を 結合 条件 に 指定 し て 、 内部 結合 を し て い ます 。 A 表 の Y 列 が 「 ３ 」 の 行 と 、 B 表 の Y 列 が 「 4 」 の 行 は 、 互い の 表 で 同じ 値 を 持た ない ため 、 結合 結果 に 含ま れ て い ませ ん 。 次に 、 内部 結合 の 書式 を 示し ます 。 内部 結合 の 書き方 に は 、 INNER JOIN を 使用 する 方法 と 省略 する 方法 の 2 通り あり ます 。 INNER JOIN を 使用 し ない 場合 は 、 結合 条件 は WHERE 句 で 指定 し ます 。 INNER JOIN を 使用 する 場合 は 、 結合 条件 は ON の 後 に 記述 し ます 。 また 、 結合 対象 と なる 表 が 、 同じ 列 名 を 持つ 場合 、 どちら の 表 の 列 な の か を 区別 する ため に 、 列 名 は 「 表 名 （ 別名 ）. 列 名 」 の よう に 記述 し ます 。 内部 結合 の 実行 例 を 示し ます 。 PROD _ ID 列 を 結合 条件 として PRODUCTS 表 と ORDERS 表 を 内部 結合 さ せ た もの です 。 この 例 で は 、 FROM 句 で 表 を 指定 し た 後 に 表 に 別名 を つけ 、 結合 条件 を 記述 し て い ます 。 自然 結合 。 自然 結合 （ NATURAL JOIN ） を 使用 する と 、 指定 さ れ た 表 の 列 名 が 一致 する もの を 結合 条件 に し て 、 結合 列 の 重複 を 除い た 形 で 結合 でき ます 。 自然 結合 の 例 を 図表 4 に 示し ます 。 自然 結合 は 、 内部 結合 で 使用 する 場合 、 「 INNER JOIN 」 の 前 に 「 NATURAL 」 を 記述 し ます *。 この とき 、 「 INNER 」 は 省略 可能 です 。 また 、 結合 条件 は 記述 し ませ ん 。 なお 、 「 NATURAL 」 は 外部 結合 で も 使用 でき ます 。 外部 結合 。 指定 し た 表 に対して 、 結合 条件 と 一致 し ない 行 も 残し て おく の が 外部 結合 （ OUTER JOIN 。 外 結合 ） です 。 外部 結合 に は 、 左 外部 結合 、 右 外部 結合 、 完全 外部 結合 の 3 種類 が あり ます 。 これ は 、 一致 し ない 行 も 残し て おく 表 を 左側 、 右側 、 両方 に する か の 違い です 。 それぞれ の 外部 結合 の 実行 結果 の 違い を 示し ます 。 外部 結合 の 結果 で は 、 結合 対象 が なく 値 が 存在 し ない 箇所 に は NULL が 入り ます 。 外部 結合 の 書式 を 示し ます 。 ORDERS 表 を すべて の 行 を 残す 表 に 指定 し て PRODUCTS 表 と 外部 結合 （ 左 外部 結合 ） を 行っ て い ます 。 ORDERS 表 の PROD _ ID 「 999 」 に 一致 する データ は 、 PRDUCTS 表 に は あり ませ ん 。 しかし 、 外部 結合 を 行っ て いる ため 「 999 」 の 値 を 持つ 行 も 結果 として 残り ます 。 自己 結合 。 一つ の 表 を あたかも 複数 存在 する か の よう に 扱い 、 同じ 表 同士 を 結合 する こと を 自己 結合 と いい ます 。 自己 結合 は 、 親子 関係 の 情報 を 持つ 表 で よく 使用 さ れ ます 。 内部 結合 や 外部 結合 と は 異なる 分類 の ため 、 内部 、 外部 どちら の 結合 に も 使用 でき ます 。 自己 結合 で は 、 同一 の 表 を FROM 句 に 指定 する ため 、 表 の 別名 を それぞれ に つけ て 、 区別 できる よう に する 必要 が あり ます 。 自己 結合 の 実行 例 を 示し ます 。 親 ID （ PARENT _ ID ） 列 を 持つ 表 X に対して 自己 結合 を 実行 し て い ます 。 一つ 目 の X 表 の PARENT _ ID と 二つ 目 の X 表 の ID を 結合 条件 に 自己 結合 し て い ます 。 これ により 、 例 の よう に 自身 の 名前 と 親 の 名前 を もつ 結合 結果 が 得 られ ます 。 結合 は 、 結合 条件 を 基 に 、 複数 の 表 から データ を 連結 し て 取り出す 操作 で ある 。 結合 に は 内部 結合 と 外部 結合 が ある 。 それぞれ の 実行 結果 の 違い を 把握 し て おく こと が 重要 で ある 。 自己 結合 により 、 一つ の 表 を 複数 存在 する か の よう に 扱い 結合 する こと も できる 。 副 問合せ 。 副 問合せ と 、 副 問合せ の 一 種 で ある 相関 副 問合せ について 学習 し ます 。 副 問合せ 。 SELECT 文 や INSERT 、 UPDATE 、 DELETE 文 内 に SELECT 文 を 書い た もの を 副 問合せ と いい ます 。 SELECT 文 の WHERE 句 内 に 、 もう 一つ SELECT 文 を 記述 し た 副 問合せ の 例 を 示し ます 。 副 問合せ を 含む SQL で は 、 はじめ に 、 副 問合せ 側 の SELECT 文 が 実行 さ れ ます 。 その後 、 副 問合せ の 結果 を 基 に 主 問合せ の 側 の SELECT 文 が 実行 さ れ ます 。 上記 例 で は 、 比較 演算 子 に 「=」 を 使用 し て い ます が 、 「<」 や 「 >」 など も 使用 でき ます 。 また 、 副 問合せ の 箇所 は 「 ( )」 で 囲む 必要 が あり ます 。 副 問合せ の 結果 が 複数 件 に なる 場合 は 、 IN 述語 による 比較 が でき ます 。 結果 が 複数 件 に なる に も 関わら ず 、 比較 演算 子 「 =」 や 「 <」 など を 使用 し た 場合 、 SQL の 実行 は 失敗 し ます 。 副 問合せ の 具体 的 な 実行 例 を 示し ます 。 ① は 、 比較 演算 子 「 <」 を 用い た 副 問合せ の 例 です 。 この ① の 例 は 、 PRODUCTS 表 から PROD _ ID が 107 の 商品 の 価格 （ PRICE ） より 安い 商品 を 抽出 し て い ます 。 内部 で は 、 はじめ に ①- 1 の 副 問合せ が 実行 さ れ PROD _ ID が 107 の 商品 の 価格 が 取り出さ れ ます 。 その後 、 ①- 2 の 主 問合せ が 実行 さ れ 、 先 に 取得 し た 価格 より 安い 商品 を 抽出 する 、 という 動作 が 行わ れ ます 。 ② は 、 IN 述語 を 用い た 副 問合せ の 例 です 。 この ② の 例 で は 、 受注 が あっ た 商品 の 情報 だけ を 抽出 し て い ます 。 内部 で は 、 ②- 1 の 副 問合せ で 、 ORDERS 表 から オーダ が あっ た 商品 の 番号 （ PROD _ ID ） が 取得 さ れ ます 。 その後 、 ②- 2 の 主 問合せ で 、 副 問合せ で 取得 し た 商品 番号 を 抽出 条件 として 、 PRODUCTS 表 から 情報 が 取得 さ れ ます 。 なお 、 ② の 副 問合せ の DISTINCT 句 は 、 付け なく て も 結果 は 同じ です 。 相関 副 問合せ 。 相関 副 問合せ は 、 副 問合せ の 中 で 主 問合せ の 表 の 値 を 参照 する 、 副 問合せ の 一 種 です 。 相関 副 問合せ の 書式 の 例 を 示し ます 。 相関 副 問合せ は 、 単純 な 副 問合せ と は 動作 が 異なり ます 。 相関 副 問合せ の 動作 は 、 以下 です 。 ① 主 問合せ の 表 から 1 件 取り出す 。 ② 取り出し た 1 件 の データ を 使用 し て 、 副 問合せ を 実行 する 。 ③ 副 問合せ 結果 を 基 に 1 件 分 の 主 問合せ を 実行 する 。 ④ 主 問合せ の 表 の データ が なくなる まで 、 ①～④ の 作業 を 繰り返す 。 相関 副 問合せ の 具体 的 な 実行 例 を 示し ます 。 相関 副 問合せ を 使用 し て 、 商品 （ PRODUCTS ） 表 から 種別 毎 の 平均 価格 より 高い 商品 を 抽出 し て い ます 。 ① で 1 件 、 PROD _ ID 101 の データ を 取り出し ます 。 次に 、 ② の 副 問合せ で 取り出し た データ の 種別 （ PROD _ CAT の 値 ） を 基 に 、 種別 の 平均 価格 を 求め て い ます 。 ③ の 主 問合せ で 、 PROD _ ID 101 の データ に対して 価格 が 種別 の 平均 価格 より 高い か を 判定 し て い ます 。 この ①～③ まで の 処理 を 繰り返し （④）、 最終 的 に 抽出 さ れ た 結果 が 出力 さ れ ます 。 EXISTS 述語 。 相関 副 問合せ の 副 問合せ と 主 問合せ の 比較 部分 に 、 EXISTS 述語 を 使用 でき ます 。 EXIST 述語 は 、 副 問合せ の 結果 が 1 件 でも あれ ば 真 を 返す 述語 です 。 EXISTS 述語 を 使用 し た 副 問合せ の SELECT 句 に は 、 「*」 を 記述 する の が 一般 的 です 。 なお 、 「*」 の 他 に も 主 キー 列 や 文字 列 を 指定 し て も 同様 に 結果 が 得 られ ます 。 EXISTS 述語 の 実行 例 を 示し ます 。 相関 副 問合せ を 使用 し て 、 受注 が あっ た 商品 の 情報 を 抽出 し て い ます 。 副 問合せ で 受注 表 に 対応 する 商品 を 取り出し 、 EXISTS 句 で 取り出し た 件数 が 1 件 以上 で ある か を 判定 し て い ます 。 EXISTS 述語 を 使用 し た 相関 副 問合せ は 、 同じ 結果 と なる IN 句 を 使用 し た 副 問合せ に 書き換え られ ます 。 SELECT 文 は 、 ② の SELECT 文 を 書き換え た もの です 。 副 問合せ は 、 SELECT 文 や INSERT 文 など の 中 に SELECT 文 を 記述 し た もの で ある 。 副 問合せ と 相関 副 問合せ の 処理 方法 が 異なる 。 IN を 使っ た 副 問合せ は 、 EXISTS 述語 を 使っ た 相関 副 問合せ に 置き換え が できる 。 集合 演算 と その他 DML 。 集合 演算 の 和 、 差 、 積 に 相当 する SQL で ある UNION 句 、 EXCEPT 句 、 INTERSECT 句 と 直積 を 行う クロス 結合 、 データ の 更新 処理 を 行う INSERT 文 、 UPDATE 文 、 DELETE 文 について 学習 し ます 。 集合 演算 に 対応 する 句 。 UNION 句 。 UNION 句 は 、 関係 演算 の 和 に 相当 する SQL です 。 UNION 句 を 使用 する と 、 表 同士 を 縦 方向 に 連結 でき ます 。 期間 ごと に 分割 し て いる 表 の データ を 連結 し たり 、 異なる テーブル 間 の 共通 の 属性 を 集約 し たり する 場合 など で 使用 し ます 。 後者 の 例 として は 、 「 教員 」 表 と 「 生徒 」 表 から それぞれ 名前 と 住所 を 取り出し て 名簿 を 作成 する こと が 挙げ られ ます 。 UNION 句 の 書式 を 示し ます 。 UNION 句 指定 時 、 ALL を 指定 し ない 場合 は 、 値 が 重複 する 行 は 排除 さ れ ます 。 一方 UNION ALL 句 を 指定 する と 、 重複 行 を 残し た まま 連結 でき ます 。 UNION 句 や 、 次 で 学習 する EXCEPT 、 INTERSECT 句 を 使用 する 場合 、 ORDER BY 句 は 、 最後 の SELECT 文 に 記述 し ます 。 最後 で は ない SELECT 文 に ORDER BY を 記述 し た 場合 、 エラー に なる ので 注意 が 必要 です 。 UNION 句 の 実行 例 を 示し ます 。 実行 例 は 、 UNION ALL を 使用 し て 、 期間 ごと に 分割 さ れ て いる 受注 表 を 連結 し た もの で 、 重複 する データ が ない ため UNION で も UNION ALL で も 結果 は 同じ です 。 この よう な 場合 で は 、 UNION ALL を 使用 し た 方 が 、 重複 を 探さ せ ない 分 、 高速 に 処理 でき ます 。 EXCEPT 句 。 EXCEPT 句 は 、 関係 演算 の 差 に 相当 し ます 。 EXCEPT 句 を 使用 する と 、 表 間 の 差分 を 求め られ ます 。 表 同士 の データ の 違い や 、 複数 の SELECT の 実行 結果 を それぞれ 表 に 保存 し て おい て 、 差異 を 見つけ たり する の に 使用 し ます 。 EXCEPT 句 の 書式 を UNION 、 UNION ALL 、 EXCEPT 、 INTERSECT 句 それぞれ の 実行 結果 の 違い を 表し ます 。 INTERSECT 句 。 INTERSECT 句 は 、 表 間 で 共通 し て いる 行 を 取り出し ます 。 関係 演算 の 積 に 相当 し ます 。 INTERSECT 句 の 書式 を 示し ます 。 クロス 結合 。 クロス 結合 （ CROSS JOIN ） を 使用 する と 集合 演算 の 直積 が 行え ます 。 クロス 結合 の 例 を 示し ます 。 FROM 句 の CROSS JOIN は 省略 し て 、 表 を 「,」 で 区切る だけ に する こと も 可能 です 。 なお 、 商 について は 、 相当 する 句 は ない ため 、 実装 時 、 個別 に 対応 する SQL 文 を 記述 する 必要 が あり ます 。 その他 DML 。 その他 DML として 更新 処理 を 行う SQL で ある INSERT 文 、 UPDATE 文 、 DELETE 文 を 学習 し ます 。 INSERT 文 。 データ の 挿入 を 行う の が INSERT 文 です 。 INSERT 文 で は 、 副 問合せ を 使用 し て 、 既存 の 表 データ を 挿入 する こと も でき ます 。 INSERT 文 の 書式 を 示し ます 。 UPDATE 文 。 データ の 変更 を 行う に は 、 UPDATE 文 を 使い ます 。 WHERE 句 で 条件 を 指定 し ない 場合 、 表 の すべて の 行 が 変更 対象 と なる ため 注意 が 必要 です 。 UPDATE 文 で は 、 値 の 部分 に SELECT 文 を 使っ た 副 問合せ を 記述 する こと により 、 既存 の データ を 使用 し た 変更 も でき ます 。 UPDATE 文 の 書式 を 示し ます 。 DELETE 文 。 データ の 削除 を 行う に は 、 DELETE 文 を 使い ます 。 WHERE 句 で 条件 を 指定 し ない 場合 、 表 の すべて の 行 が 削除 対象 と なる ため 注意 が 必要 です 。 DELETE 文 の 書式 を 示し ます 。 また 、 INSERT 、 UPDATE 、 DELETE 文 の 使用 例 を まとめ て 示し ます 。 集合 演算 の 和 、 差 、 積 は 、 SQL で は それぞれ UNION 句 または UNION ALL 句 、 EXCEPT 句 、 INTERSECT 句 が 対応 する 。 直積 は 、 クロス 結合 が 対応 する 。 データ 更新 用 SQL で ある INSERT 、 UPDATE 、 DELETE 文 も 確認 し て おく 。 埋込み SQL 、 カーソル 、 ストアドプロシージャ 。 埋込み SQL と 埋込み SQL で 実行 結果 を 扱う ため の カーソル 、 DBMS に対する 操作 を まとめる 機能 で ある ストアドプロシージャ について 学習 し ます 。 埋込み SQL 。 埋込み SQL は 、 C や COBOL など の プログラミング 言語 に SQL を 組み込む ため の 仕組み です 。 SQL を 埋め込ん だ とき 、 C や COBOL など の こと を 親言語 と 呼び ます 。 埋込み SQL を 実行 する 場合 は 、 プリプロセッサ を 用い て 親言語 内 に 記述 し た SQL の 事前 処理 を し ます 。 その後 、 親言語 の コンパイラ で コンパイル し て 、 実行 し ます 。 埋込み SQL は 、 静的 SQL と 動的 SQL に 分類 さ れ ます 。 静的 SQL 。 静的 SQL は 、 プログラム 実行 前 に 親言語 内 に 記述 さ れ た SQL を 解析 し て おく 方式 です 。 動的 SQL 。 動的 SQL は 、 プログラム 実行 の 都度 、 動的 に SQL を 解析 する 方式 です 。 動的 SQL の メリット と 静的 SQL の メリット 。 静的 SQL で は 、 プリプロセッサ を 使用 し た プリコンパイル まで に あらかじめ 実行 する SQL を 決定 し て おく 必要 が あり ます 。 その ため 、 プログラム 実行 時 に は 、 決め られ た SQL しか 実行 さ せる こと は でき ませ ん 。 動的 SQL で は 、 プログラム 実行 時 、 自由 に SQL を 作成 し て 実行 さ せる こと が でき ます 。 一方 、 静的 SQL の メリット は 、 プログラム 実行 前 に プリコンパイル により SQL の 解析 処理 が 終了 し て いる ため 、 プログラム 実行 時 、 SQL を 高速 に 処理 できる 点 が 挙げ られ ます 。 カーソル 。 カーソル は 、 C や COBOL など の 親言語 （ 手続き 型 ） において 、 複数 件 と なる SQL の 実行 結果 を 順番 に 処理 する ため の 仕組み です 。 カーソル を 使用 する に は 、 以下 の 手続き を 踏む 必要 が あり ます 。 ① カーソル の 宣言 。 カーソル と 実行 する SQL を 定義 する 。 ② カーソル の オープン 。 SQL が 実行 さ れ 結果 行 が 確定 する 。 ③ データ の フェッチ 。 結果 行 から 1 件 取り出し 、 結果 を 親言語 の 変数 に 格納 する 。 ④ カーソル の クローズ 。 カーソル の 使用 を 終了 し 、 リソース を 解放 する 。 カーソル の 書式 を 示し ます 。 ③ データ の フェッチ で INTO 句 の 後 に 指定 する 変数 は 、 ホスト 変数 と いい ます 。 ホスト 変数 は 、 SQL と 親言語 間 で 値 を やり取り する ため の 変数 です 。 通常 の 列 名 など と 変数 を 区別 する ため 、 SQL 内 で は 変数 の 最初 に 「:」 を 記述 し ます 。 フェッチ で は 、 実行 する 度 に ポインタ を 次 の 行 へ 移動 し 、 データ を 取り出し て 変数 へ 格納 する 、 という 処理 が 行わ れ ます 。 フェッチ の 動作 イメージ を 示し ます 。 C 言語 で カーソル を 使っ た サンプル コード を 示し ます 。 静的 SQL を 用い た 例 に なり ます 。 なお 、 動的 SQL を 記述 する 場合 は 、 説明 欄 の よう に 、 PREPARE で 前 処理 し て から 実行 する よう に 記述 し ます 。 カーソル を 使用 し た 更新 。 カーソル を 使用 し た フェッチ 中 、 ポインタ が 指し て いる 行 に対して 更新 、 削除 する こと が でき ます 。 ポインタ が 指し て いる 行 に 更新 を 行う に は 、 UPDATE 文 や DELETE 文 の WHERE 句 に CURRENT OF < カーソル 名 > を 記述 し ます 。 書式 と サンプル コード を 示し ます 。 JAVA で の カーソル 。 JAVA で は 、 カーソル そのもの は あり ませ ん が 、 カーソル の 考え方 は 使用 さ れ て い ます 。 JAVA で SQL の 実行 結果 を 扱う PreparedStatement や ResultSet クラス で は 、 内部 的 に カーソル の 概念 が 利用 さ れ て い ます 。 ストアドプロシージャ 。 ストアドプロシージャ は 、 あらかじめ 表 や ビュー へ の 操作 を まとまっ た 手続き として DBMS に 登録 し て おく 機能 です 。 ストアドプロシージャ は 、 DBMS に コンパイル 済み の モジュール として 登録 さ れ ます 。 クライアント は 、 ストアドプロシージャ を 呼び出す こと で 、 DBMS に対する 一連 の 操作 を 行う こと が でき ます 。 ストアドプロシージャ を 使用 する 主 な 利点 を 示し ます 。 クライアント と の ネットワーク 通信 量 の 削減 。 1 回 の ストアドプロシージャ 呼び出し で 、 複数 の 操作 を 一括 し て DBMS 内 で 処理 できる ため 、 クライアント と の 通信 量 が 減る 。 セキュリティ の 向上 。 データ へ の アクセス を プロシージャ 呼び出し に 限定 し 、 表 へ の 直接 の アクセス を 禁止 できる 。 アクセス 方法 を 限定 できる よう に なる 。 また 、 SQL が ネットワーク 上 を 流れ ない ため 、 セキュリティ が 向上 する 。 データ 操作 の 標準 化 。 データ アクセス を プロシージャ 呼び出し に 限定 する こと により 、 使用 する SQL を 共通 化 できる ため 、 データ 操作 の 標準 化 に つながる 。 埋込み SQL は 、 C や COBOL など の 親言語 プログラム から SQL を 実行 する ため の 仕組み で ある 。 カーソル を 使用 する に は 、 DECLARE 、 OPEN 、 FETCH 、 CLOSE 処理 を 順に 行う 。 ストアドプロシージャ を 使う こと によって 、 ネットワーク 通信 量 の 低減 や セキュリティ の 向上 など が 期待 できる 。 
