 トランザクション 。 トランザクション 処理 について 、 「 同時 実行 制御 」 の 必要 性 、 同時 実行 制御 を 実現 する ため の ロック の 仕組み を 中心 に 学習 し て いき ます 。 学習 は 、 トランザクション の 概念 から 開始 し ます 。 トランザクション の 概念 。 「 太郎 が 自分 の 預金 口座 から 花子 の 口座 に 1 万 円 入金 する 」 こと を 簡略 化 し て 、 手順 で 考え て み ましょ う 。 ① 太郎 の 口座 を 照会 し 残高 を 読み取り 。 ② 読み取っ た 残高 から 1 万 円 減算 し た 金額 を 太郎 の 口座 に 書き込み 。 ③ 花子 の 口座 を 照会 し 残高 を 読み取り 。 ④ 読み取っ た 残高 に 1 万 円 加算 し て 花子 の 口座 に 書き込み 。 これら ①～④ の 操作 は 一連 の 処理 として 扱っ て 初めて 意味 が あり ます 。 途中 で いずれ か の 操作 が 失敗 し たら 、 処理 全体 を 取り消す 必要 が あり ます 。 トランザクション と は 、 これら 一連 の 操作 を ひとつ の 処理 として 扱う ため の 概念 です 。 すべて が 成功 し て 初めて 意味 を もつ 一連 の 処理 の こと を トランザクション と 呼び ます 。 また 、 一連 の 処理 つまり トランザクション を 確定 する 操作 の こと を コミット 処理 、 取り消す 処理 の こと を ロール バック 処理 と 呼び ます 。 ACID 。 トランザクション は 、 ACID と 呼ば れる 四つ の 特性 を 満足 し なけれ ば なり ませ ん 。 原子 性 （ Atomicity ） 。 一連 の 処理 は 、 すべて 行わ れる か 、 まったく 行わ れ ない か いずれ か の 観点 から 実行 さ れ なけれ ば なり ませ ん 。 つまり 中途半端 な 状態 で 実行 を 終了 さ せ て は なら ない という こと です 。 ②～③ の 間 で システム に 何らかの 障害 が 発生 し た 場合 に も 、 障害 から の 復旧 時 に は 太郎 の 口座 は 1 万 円 が 減額 さ れる 前 の 状態 に 戻す 必要 が あり ます 。 一貫 性 （ Consistency ） 。 どの よう な 場合 において も 、 データ の 整合 性 （ 一貫 性 ） を 保た なけれ ば なら ない という こと です 。 あらかじめ 定め た 制約 に 違反 する データ が 発生 する こと を 許し て は なり ませ ん 。 口座 残高 が 0 円 以下 に なる 場合 に は 口座 から の 引き出し を 許さ ない という 業務 上 の 制約 を 設定 し た 場合 、 ① の 段階 で 処理 そのもの を 異常 終了 さ せ なけれ ば なり ませ ん 。 独立 性 （ Isolation ） 。 複数 同時に 実行 さ せ た 場合 に も 、 互い の 処理 が 影響 を 与え ず 、 あたかも 逐次 実行 さ れ た か の よう な 結果 を 得 なけれ ば なら ない という こと です 。 ①～② の 間 で 母親 が 太郎 の 口座 に 入金 する 処理 を 先 に 実行 し て しまっ たら どう なる でしょ う か 。 太郎 の 預金 データ は 実体 と 矛盾 し た もの に なる かも しれ ませ ん 。 独立 性 を 満足 する に は この よう な 処理 を 許し て は なり ませ ん 。 耐久 性 （ Durability ） 。 実行 完了 後 に 何らかの 障害 が 発生 し た として も 、 いったん コミット し た データ は 失っ て は なら ない という こと です 。 一連 の 処理 を 正常 終了 し た が 、 その後 システム に 障害 が 発生 し た 。 障害 発生 時点 で は 太郎 の 更新 さ れ た 口座 残高 は まだ メモリー 上 に あり 、 まだ ディスク に 書き込ま れ て い なかっ た ため 、 更新 データ を 損失 し た 。 耐久 性 を 満足 する に は この よう な 状況 を 発生 さ せ て は なり ませ ん 。 ACID 特性 を アプリケーション で 実現 する こと も 可能 です が 、 その 実装 は 気 の 遠く なる ほど 煩雑 な もの と なり ます 。 また ACID 特性 を 厳密 に 実装 する と 、 実用 上 、 特に 性能 面 で の 劣化 が 懸念 さ れ ます 。 したがって 、 通常 、 トランザクション 制御 は データ を 管理 する DBMS に 任せ ます が 、 データベース スペシャリスト は 、 DBMS が どの よう に 、 また どの よう な レベル で ACID を 実現 し て いる か を 理解 し て おく 必要 が あり ます 。 トランザクション 制御 。 DBMS で は トランザクション の 開始 は 暗黙 的 に 行わ れ ます 。 そして 、 SQL の COMMIT 文 または ROLLBACK 文 まで が トランザクション の 単位 と なり ます 。 その 例 を 示し ます 。 処理 で は 、 太郎 の 預金 口座 から 10 , 000 円 を 減算 し 、 花子 の 預金 口座 に 10 , 000 円 加算 する こと を SQL で 実行 し て い ます 。 なお 、 ( A ) の コミット 時点 で の 、 太郎 の 口座 番号 は 1112 、 預金 額 は 40 , 000 円 、 花子 の 口座 番号 は 1129 、 預金 額 は 20 , 000 円 と し て い ます 。 SQL 処理 内容 。 ① SELECT 。 太郎 の 口座 番号 1112 を 指定 し て 、 太郎 の 預金 額 が 40 , 000 円 で ある こと を 確認 。 ② UPDATE 。 太郎 の 口座 番号 1112 を 指定 し て 、 太郎 の 預金 額 を 10 , 000 円 減算 。 ③ SELECT 。 花子 の 口座 番号 1129 を 指定 し て 、 花子 の 預金 額 が 20 , 000 円 で ある こと を 確認 。 ④ UPDATE 。 花子 の 口座 番号 1129 を 指定 し て 、 花子 の 預金 額 を 10 , 000 円 加算 。 ⑤ COMMIT 。 SQL 処理 ①～④ を コミット 。 処理 で は 、 ⑤ の COMMIT 文 発行 により ①～④ の 一連 の SQL 実行 内容 は 確定 し 、 太郎 の 預金 額 は 30 , 000 円 、 花子 の 預金 額 も 30 , 000 円 に 更新 さ れ ます 。 また 、 ⑤ の COMMIT 文 の かわり に ROLLBACK 文 を 発行 すれ ば 、 処理 を 取り消す こと が でき ます 。 この 場合 、 ロールバック 処理 を 完了 する と 、 太郎 の 預金 額 は 元 の 40 , 000 円 、 花子 の 預金 額 も 元 の 20 , 000 円 の まま と なり ます 。 なお 、 この 例 で は 明示 的 に COMMIT 文 を 発行 し て い ます が 、 1 SQL ＝ 1 トランザクション で 実行 する こと を 既定 （ デフォルト ） の 動作 と し て いる DBMS も あり ます 。 この 場合 トランザクション は SQL 発行 ごと に 暗黙 的 に 開始 し 、 処理 が 成功 する と 暗黙 的 に コミット 処理 が 行わ れ ます 。 処理 に 失敗 する と 暗黙 的 な ロール バック 処理 が 行わ れ ます 。 当然 この デフォルト の 暗黙 動作 を 解除 し て 、 ユーザー が COMMIT 文 、 ROLLBACK 文 を 発行 する モード に 移行 する オプション も 提供 さ れ て い ます 。 また 、 明示 的 に ユーザー が 開始 を 宣言 する ため に 、 START TRANSACTION 文 や BEGIN TRANSACION 文 を 使用 できる もの も あり ます 。 中 に は 、 DDL 実行 は 暗黙 コミット が かかる が 、 DML 実行 について は 明示 的 な COMMIT 文 の 入力 を 必要 と する もの も あり ます 。 この よう に 、 実装 は DBMS ごと に 特徴 が ある ので 注意 が 必要 です 。 TP モニター と の 連携 。 TP モニター と は 複数 の システム を 連携 さ せ て トランザクション 処理 を 行う 場合 に 使用 する ミドル ウエア です 。 DBMS が TP モニター の 管理 下 に ある 場合 に は 、 トランザクション を 処理 する アプリケーション は TP モニター に対して コミット 処理 、 ロールバック 処理 の 要求 を 行い ます 。 トランザクション と は 意味 を もっ た 一連 の 処理 の 単位 で ある 。 トランザクション は 四つ の ACID 特性 （ 原子 性 、 一貫 性 、 独立 性 、 耐久 性 ） を 満足 する 必要 が ある 。 DBMS で は 、 トランザクション は SQL の COMMIT 文 、 ROLLBACK 文 の 単位 で ある 。 同時 実行 制御 。 直列 化 可能 性 。 ACID の 独立 性 ( Isolation ) を 実現 する ため に は 、 複数 の トランザクション を 同時に 並列 実行 さ せ た 場合 に も 、 それぞれ を 個々 に 実行 し た 場合 と 同じ 結果 を 得る こと が 必要 です 。 トランザクション 1 、 トランザクション 2 が ともに データ A 、 データ B に対して 何らかの 処理 を 行う と し ます 。 この 二つ の トランザクション を 示す よう に 並列 実行 さ せ た 場合 の 結果 は 、 示す よう に トランザクション 1 → トランザクション 2 の 順 に 直列 に 実行 さ せ た 場合 、 または トランザクション 2 → トランザクション 1 の 順 に 直列 に 実行 さ せ た 場合 と 同じ で なけれ ば なり ませ ん 。 並列 実行 し た 結果 が 、 直列 実行 し た 結果 と 等しく なる よう な トランザクション 実行 スケジュール の こと を 直列 化 可能 スケジュール （ Serializable Schedule ） と いい ます 。 DBMS は 直列 化 の ため に 、 なんらかの 同時 実行 制御 の 仕組み を 実装 する 必要 が あり ます 。 同時 実行 制御 の 方式 。 同時 実行 制御 方式 の 代表 的 な もの として 、 時刻 印 方式 、 楽観 的 方式 、 ロック 方式 が あり ます 。 時刻 印 方式 。 データ 参照 時刻 、 更新 時刻 を 競合 判定 の ため の データ として 記録 し 、 直列 化 を 妨げる よう な 競合 が 発生 し た か どう か を トランザクション 開始 時刻 と 比較 し て 判定 する 方式 です 。 データ へ の アクセス が 競合 し た と 判定 し た 場合 に は 処理 を ロール バック し ます 。 楽観 的 方式 。 時刻 印 方式 の 考え方 を さらに 発展 さ せ た もの です 。 トランザクション 間 に 直列 化 を 妨げる よう な 競合 は ない もの と 楽観 的 に とらえ て 実行 し 、 実際 に 競合 が 発生 し た か どう か は データ 書き込み 時 に 確認 する 方式 です 。 更新 予定 の データ を 、 いったん 読み取っ て おき 、 更新 作業 の 直前 に 、 変更 さ れ て い ない か どう か を 確認 、 変更 さ れ て い たら 処理 を ロール バック し ます 。 ロック 方式 。 DBMS で 一般 的 に 採用 さ れ て いる 方式 です 。 同じ データ へ の アクセス が 複数 の トランザクション から 行わ れる 場合 、 先 に データ を ロック し た トランザクション が 、 後 から 来 た トランザクション を 待た せる という 考え方 に 基づい て い ます 。 この 方式 を 用いれ ば 直列 化 を 比較的 容易 に 実現 可能 です 。 また この 方式 は 楽観 的 方式 と 対比 し て 悲観 的 方式 と も 呼ば れ ます 。 以後 、 ロック 方式 について 以下 の シナリオ を 基 に 学習 を 進め ます 。 シナリオ 。 今 、 太郎 の 預金 額 は 30 , 000 円 です 。 太郎 が 自分 の 口座 から 10 , 000 円 を 引き出す ため の トランザクション と 、 母親 が 太郎 の 口座 に 10 , 000 円 入金 する ため の トランザクション が 同時に 実行 さ れ ます 。 最初 に 、 同時 実行 制御 が 行わ れ ない 環境 で 、 この 二つ の トランザクション が 、 次 の よう に 処理 さ れる と どう なる か を 考え ましょ う 。 まず 、 太郎 の トランザクション が 太郎 の 預金 額 を 読み取り ます 。 この 時点 で の 読み取り 額 は 30 , 000 円 です 。 次に 、 母親 の トランザクション が 太郎 の 預金 額 を 読み取り ます 。 この 時点 で の 読み取り 額 も 同じく 30 , 000 円 です 。 続け て 、 母親 の トランザクション が 、 太郎 の トランザクション より 先 に 、 読み取り 額 30 , 000 円 に 入金 額 10 , 000 円 を 加え た 40 , 000 円 を 太郎 の 預金 額 として 書き込み ます 。 その後 、 太郎 の トランザクション が 読み取り 額 30 , 000 円 から 引出 額 10 , 000 円 を 引い た 20 , 000 円 を 書き込み ます 。 この 時点 で 、 母親 の トランザクション による 更新 データ は 、 太郎 の トランザクション により 上書き さ れ て しまい ます 。 結局 、 太郎 の 預金 残高 は 、 本来 は 自分 の 引出 額 \ 10 , 000 を 減算 、 母親 から の 入金 \ 10 , 000 を 加算 し て 、 もと の 30 , 000 円 で ある べき ところ が 20 , 000 円 に なっ て しまい ます 。 この よう に 、 正常 に 実行 さ れ た 最後 の データ 更新 が 、 それ まで の 更新 を 上書き し て しまう 現象 を ロスト アップデート （ Lost Update ） 、 または 更新 喪失 と いい ます 。 この 現象 は 複数 の トランザクション が 同じ データ を 取り出し て 、 変更 、 書き込ん だ 場合 に 発生 し ます 。 次に 、 この 二つ の トランザクション 処理 を ロック により 排他 制御 する こと を 考え ます 。 ロック による 排他 制御 は 、 データ を アクセス する 際 に 対象 データ に ロック を かけ 、 処理 が 終了 し たら ロック を 解除 する 方式 です 。 ロック が かかっ て いる 間 は 他 の トランザクション から の アクセス は 待ち （ ロック 待ち ） と なり ます 。 データ を ロック する 操作 を LOCK 操作 、 ロック を 解除 する 操作 を UNLOCK 操作 と いい ます 。 この 方式 に 従え ば 、 ある トランザクション が データ を 読み取っ て 、 処理 を し て 書き込み を 完了 する まで 、 データ へ の アクセス 権 は ロック を かけ て いる トランザクション だけ が もつ こと に なり ます 。 太郎 の トランザクション が 預金 データ を 読み取る 前 に 、 ロック し て しまえ ば 、 10 , 000 円 を 減算 し て 、 残高 を 書き込み 、 ロック 解除 する まで 、 母親 の トランザクション は ロック 待ち と なり 、 処理 を 進める こと は でき ませ ん 。 したがって 、 太郎 の 更新 処理 が 母親 の 更新 処理 を 上書き し て データ が 不 整合 に なっ て しまう こと を 防止 する こと が でき ます 。 マルチ バージョン 方式 。 マルチ バージョン 方式 と は 、 更新 時刻 を もと に し た 複数 の バージョン の データ を DBMS が 管理 し 、 トランザクション の 開始 時刻 を もと に 対応 し た バージョン の データ を 提供 する 方式 です 。 ロック による 排他 制御 だけ で は 、 ロック 待ち が 多発 し 全体 的 な 処理 効率 は 悪く なり ます 。 したがって 実際 の DBMS で は 複数 トランザクション による データ 競合 を できるだけ 排除 する ため この 方式 を とりいれ 、 ロック による 排他 制御 方式 と 併用 し て いる もの も あり ます 。 複数 の トランザクション を 並列 実行 し た 場合 、 直列 実行 し た 場合 と 同じ 結果 が 得 られる なら ば 、 直列 化 可能 で ある 。 同時 実行 制御 の 方式 で 代表 的 な もの として 、 時刻 印 方式 、 楽観 的 制御 方式 、 ロック 方式 が ある 。 ロック 方式 は 、 相手 を 待た せる という 考え方 に 基づい て いる 。 ロック による 排他 制御 。 ロック の モード 。 ロック により 他 トランザクション から の すべて の 操作 が ロック 待ち 状態 に なる と 、 トランザクション 処理 全体 の 実行 性能 は 低下 し て しまい ます 。 そこで 、 現実 活用 を 考慮 する と ロック に は 他 の トランザクション から の データ 読み取り アクセス を 許可 する 「 共有 ロック 」 と 、 読み取り アクセス も 許さ ない 「 占有 ロック 」 の 2 種類 の モード が 必要 と なり ます 。 実際 の DBMS で 提供 し て いる ロック は これら 以外 に も 多数 の モード が 存在 し 、 その 種類 も DBMS ごと に 異なり ます が 、 これら 2 種類 に 大別 でき ます 。 また 占有 ロック を 「 専有 ロック 」 「 排他 ロック 」 と 称する 場合 も あり ます が 意味 的 に は 同じ です 。 読み込ん だ データ を 処理 中 に その データ が 他 の トランザクション から 更新 さ れる こと を 防止 する 場合 に は 、 共有 ロック を かけ て 処理 を 行い ます 。 データ の 書き込み 操作 を 行う 場合 に は 占有 ロック を かけ て 処理 を 行い ます 。 占有 ロック と 共有 ロック の 競合 関係 。 占有 ロック と 共有 ロック に は 競合 関係 が あり ます 。 これ を 示し ます 。 「 先行 」 は 、 ある データ に対して 、 他 の トランザクション に 先行 し て ロック を かけ て いる トランザクション を 意味 し ます 。 「 要求 」 は 同じ データ に対して 後 から ロック を かけ に いく トランザクション を 意味 し ます 。 ○ 印 の もの は 「 先行 」 と 「 要求 」 に ロック の 共存 が 許さ れ 、 Ｘ 印 の もの は 共存 が 許さ れ ない という こと を 意味 し ます 。 さらに 、 以下 の ロック 操作 シナリオ で 、 これら の 競合 関係 を 習得 し て おき ましょ う 。 ロック 操作 シナリオ 。 ① トランザクション T 1 と T 2 は 同じ データ D を アクセス する 。 ② T 1 は T 2 に 先行 し て データ D に 共有 ロック または 占有 ロック を 既に かけ て いる 。 ③ T 2 は T 1 の 後 から データ D に 占有 ロック または 共有 ロック を かけ に いく 。 ④ T 1 、 T 2 は データ D に対する 処理 終了 後 、 ロック を 解放 （ UNLOCK ） する 。 先行 トランザクション T 1 が データ D に 共有 ロック を かけ て いる 場合 。 後 から T 2 が D に 共有 ロック を かけ に いっ て も 待ち に は なり ませ ん 。 しかし 、 後 から T 2 が D に 占有 ロック を かけ に いく と 、 T 1 が 共有 ロック を 解放 する まで T 2 は 待ち と なり ます 。 先行 トランザクション T 1 が データ D に 占有 ロック を かけ て いる 場合 。 後 から T 2 が D に 占有 ロック または 共有 ロック を かけ に いく と （ 要求 に いく と ） 、 いずれ の 場合 も T 2 は T 1 が 占有 ロック を 解放 する まで ロック 待ち と なり ます 。 T 1 が 占有 ロック を 解放 し た 時点 で T 2 は D に ロック を かける こと が でき ます 。 ロック の 粒 度 。 ロック の 対象 範囲 は 基本 的 に 行 、 表 の 単位 です が 、 ブロック （ ページ ） という 記憶 単位 で かかる もの も あり ます 。 なお 、 ブロック ( ページ ） は 、 行 データ を 格納 する ため の 物理 記憶 単位 で あり 、 第 10 章 （ テーマ 039 ） で その 詳細 を 学習 し ます 。 ロック の 粒 度 と は 、 ロック の 対象 範囲 の こと です 。 表 → ブロック （ ページ ） → 行 の 順 に 粒 度 は 小さく なっ て いき ます 。 一般 的 に 、 トランザクション を 同時に 複数 実行 し た 場合 、 ロック の 粒 度 は 小さい ほど 、 並行 性能 は 向上 し ます 。 これ は 、 ロック 待ち や デッドロック （ 次 の 学習 テーマ です ） の 発生 確率 が 少なく なる ため です 。 しかし 、 一つ の トランザクション 内 で 大量 の データ 更新 を 行う 場合 、 ロック の 粒 度 が 小さい と 、 DBMS の 処理 負荷 が 大きく なり 、 CPU の 負荷 は 増し ます 。 なお 、 ロック の 操作 は DBMS が 行い ます が 、 ユーザ が 意図 的 に 表 の 単位 で ロック 操作 する ため の LOCK TABLE 文 、 行 の 単位 で ロック する ため の SELECT FOR UPDATE 文 を 提供 し て いる もの も あり ます 。 また 、 ロック 待ち が 発生 し た 場合 、 待た ず に エラー を 返す よう な オプション を 提供 し て いる もの も あり ます 。 2 相 ロッキング プロトコル 。 直列 化 可能 性 を 保証 する ため の 有名 な 規約 として 「 2 相 ロッキング プロトコル 」 が あり ます 。 これ は トランザクション 内 で の ロック 操作 に関する 規約 です 。 この 規約 に したがえ ば トランザクション 内 で の ロック の 操作 を 、 ロック を かけ て いく 操作 で 構成 さ れる 成長 相 と ロック を 解除 し て いく 縮退 相 の 2 相 に 分離 する こと に なり ます 。 この ため 、 この 規約 に 従え ば ロック を 解除 し た 後 に 新た な ロック を かける 操作 は 許さ れ ませ ん 。 したがって 、 すべて の トランザクション が この 規約 に したがっ て ロック 操作 を 行え ば 直列 化 が 可能 と なり ます 。 しかし 、 この 規約 に したがっ た ロック 操作 を 行わ ない トランザクション が ひとつ でも 存在 する と 直列 化 は 保証 でき なく なり ます 。 また ロック を 保持 する 期間 も 長く なる ので デッドロック を 引き起こし やすく なり ます 。 データ の 書き込み を 行う 場合 に は 占有 ロック 、 読み取り を 行う 場合 に は 共有 ロック を 使用 する 。 ロック の 粒 度 は ロック を かける 範囲 で あり 、 表 → ブロック （ ページ ） → 行 の 順 に 粒 度 は 小さく なる 。 2 相 ロック と は 、 直列 化 可能 性 を 保証 する ため の ロック 方式 で ある 。 デッドロック 。 デッドロック と は 。 ロック による 排他 制御 で は 、 デッドロック という 現象 が 発生 する 場合 が あり ます 。 デッドロック と は 複数 の トランザクション が ロック を かけあっ て 、 その 解放 を 待ち あう 状態 です 。 それでは 、 基 に し て デッドロック の 現象 を 学習 し て いき ましょ う 。 トランザクション T 1 、 T 2 は データ D 1 、 D 2 に それぞれ 以下 の 順番 で ロック を かけ ます 。 ① まず 、 T 1 が D 1 に 占有 ロック を かけ ます 。 ② 次 に T 2 が D 2 に 占有 ロック を かけ ます 。 ③ 続け て T 2 は D 1 に 占有 ロック を かけ に いき ます 。 しかし 、 D 1 に は すでに T 1 が 占有 ロック を かけ て いる ため 、 この 時点 で T 2 は ロック 待ち と なり 、 T 2 は 、 T 1 が D 1 の ロック を 解放 する まで 待ち 続け ます 。 ④ さらに 続け て 、 T 1 が D 2 に 占有 ロック を かけ に いき ます 。 しかし 、 D 2 に は T 2 が 占有 ロック を かけ て いる ため 、 この 時点 で T 1 も ロック 待ち と なり 、 T 1 は 、 T 2 が D 2 の ロック を 解放 する まで 待ち 続け ます 。 結局 、 ④ の 時点 で T 1 も T 2 も お互い の ロック 解除 を 待ち合わせる こと に なり 、 双方 の 処理 は 何 も 進ま なく なり ます 。 この 現象 を 「 デッドロック 」 と 呼び ます 。 2 相 ロッキング プロトコル と デッドロック 。 ここ で 、 再度 、 T 1 , T 2 の ロック の かけ 方 に 注目 し ましょ う 。 この ロック の かけ 方 は T 1 , T 2 とも に 2 相 ロッキング プロトコル の 規約 を 守っ て い ます 。 T 1 、 T 2 とも に 、 途中 で UNLOCK 操作 は 、 はいっ て い ませ ん 。 デッドロック は 成長 相 で 発生 し て い ます 。 2 相 ロッキング プロトコル は あくまでも 直列 化 可能 性 を 保証 する ため の 規約 で あり 、 2 相 ロッキング プロトコル に従って も デッドロック は 発生 する こと を 再度 、 理解 し て おき ましょ う 。 待ち グラフ 。 デッドロック の 検出 に は 「 待ち グラフ 」 の 活用 が 有効 です 。 デッドロック を 待ち グラフ で 表現 し た もの を 示し ます 。 トランザクション T 1 、 T 2 を サークル （ 円 ) で 表現 し て い ます 。 トランザクション が ロック 待ち に なっ た 時点 で 以下 の よう に サークル 間 に 矢印 を 引い て いき ます 。 ① T 2 は T 1 の ロック 解放 を 待つ 。 T 2 から 、 T 2 を ロック 待ち に し た T 1 に対して 矢印 を 引き ます 。 ② T 1 は T 2 の ロック 解放 を 待つ 。 T 1 から 、 T 1 を ロック 待ち に し た T 2 に対して 矢印 を 引き ます 。 矢印 が 循環 し て 、 サーキット （ 巡回 閉路 ） が 完成 し たら デッドロック が 発生 し た と 判定 し ます 。 デッドロック は 二つ の トランザクション 間 のみ で 発生 する わけ で は あり ませ ん 。 引き続き 、 三つ の トランザクション T 1 、 T 2 、 T 3 が データ D 1 、 D 2 、 D 3 に アクセス する 場合 、 デッドロック が 発生 する こと を 、 待ち グラフ を 利用 し て 確認 し て み ましょ う 。 まず T 1 が D 1 に 、 T 2 が D 2 に 、 T 3 が D 3 に 、 それぞれ 占有 ロック を かけ ます 。 この 状態 で は 、 どの トランザクション に も ロック 待ち は 発生 し ない ので 、 待ち グラフ に 矢印 は 引き ませ ん 。 次に 、 T 1 が D 2 に 占有 ロック を かけ に いく と 、 D 2 は すでに T 2 により ロック さ れ て いる ため 、 T 1 は ロック 待ち に なり ます 。 ここ で 、 待ち グラフ で T 1 を ロック 待ち さ せ た T 2 へ T 1 から 矢印 を 引き ます 。 続け て 、 T 2 が D 3 に 占有 ロック を かけ に いく と 、 D 3 は すでに T 3 により ロック さ れ て いる ため 、 T 2 は ロック 待ち に なり ます 。 ここ で 、 待ち グラフ で T 2 を ロック 待ち さ せ た T 3 へ T 2 から 矢印 を 引き ます 。 最後 に 、 T 3 が D 1 に 占有 ロック を かけ に いく と 、 D 1 は すでに T 1 により ロック さ れ て いる ため 、 T 3 は ロック 待ち に なり ます 。 ここ で T 1 ～ T 3 は すべて ロック 待ち と なり デッドロック 状態 と なり ます 。 待ち グラフ で は T 3 を ロック 待ち さ せ た T 1 へ T 3 から 矢印 を 引き ます 。 サーキット が できあがり 、 デッドロック の 発生 を 判定 でき ます 。 待ち グラフ は 、 DBMS による デッドロック 検知 に 使用 さ れ ます 。 デッドロック を 検知 し た DBMS は 、 サーキット 内 の いずれ か の トランザクション 処理 を ロール バック し 、 エラー 通知 を アプリケーション に 返し ます 。 トランザクション 処理 の ロールバック 方法 は DBMS によって 実装 が 異なり ます 。 デッドロック の 引き金 と なっ た いずれ か の トランザクション 全体 を ロール バック する もの も あれ ば 、 ロールバック の 対象 は 、 トランザクション 内 の 最後 の SQL 文 に 限定 さ れる もの も あり ます 。 いずれ の 場合 も 、 デッドロック による ロールバック を DBMS から 通知 さ れ た アプリケーション は 、 再 実行 など の エラー 処理 を 行う 必要 が あり ます 。 デッドロック を 抑制 する 方法 。 デッドロック を 抑制 する ため の 方法 として は 、 「 ロック の 粒 度 を 小さく する 」 など も 考え られ ます が 、 最も 効果 的 な 方法 は 、 データ に ロック を かけ て いく 順番 、 つまり データ 更新 順 を ルール 化 する こと です 。 本 テーマ の 最初 に とりあげ た デッドロック 例 で は 、 トランザクション T 1 は D 1 → D 2 の 順 、 トランザクション T 2 は D 2 → D 1 の 順 に 占有 ロック を かけ に いっ て デッドロック が 発生 し まし た 。 ここ で データ 更新 は 必ず D 1 → D 2 の 順 に 行う という 規則 を 設け たら どう でしょ う か 。 ロック 待ち は 発生 し ます が 、 デッドロック の 発生 は 抑制 でき ます 。 なお 、 時刻 印 方式 、 楽観 的 制御 方式 は 、 そもそも ロック を 使用 し ない 同時 実行 制御 方式 で ある ため 、 デッドロック は 発生 し ませ ん 。 デッドロック は 、 複数 の トランザクション が ロック を かけあう こと により 処理 が それ 以上 進ま なく なっ て しまう 状態 で ある 。 デッドロック の 検出 を 行う に は 「 待ち グラフ 」 が 有効 で ある 。 デッドロック を 抑制 する ため の 最も 有効 な 方法 は データ の 更新 順 を ルール 化 する こと で ある 。 隔離 性 水準 。 同時 実行 制御 が うまく 行わ れ ない 場合 に は 、 すでに 学習 し た 「 ロスト アップデート （ Lost Update )」 の 他 に も 、 問題 が 発生 する 可能 性 が あり ます 。 DBMS が トランザクション の 実行 を 完全 に 直列 スケジュール すれ ば 、 この よう な 問題 は 発生 し ませ ん が 、 同時 実行 時 の スループット は 著しく 低下 し て しまい ます 。 この ため 、 直列 性 を 犠牲 に し て 、 どの 程度 まで 、 これら の 問題 を 許容 できる か という 指標 が 「 隔離 性 水準 」 として 定め られ て い ます 。 並列 実行 時 の 問題 点 。 ファントムリード 。 同 一 トランザクション 内 で 同じ 照会 を 繰り返し た 場合 、 新た な データ を 読み取る こと を 、 ファントムリード ( Phantom Read ) と 呼び ます 。 預金 データベース から 、 預金 額 が 30 , 000 円 以上 の 預金 者 を 確認 する ため の 照会 を 同じ トランザクション 内 で 複数 回 実行 し ます 。 初回 の 照会 実行 時点 で は 30 , 000 円 以上 の 預金 者 は 太郎 と 花子 だけ でし た 。 しかし 、 再度 同じ 照会 を 実行 する と 、 結果 に は 、 他 の トランザクション により 預金 額 を 40 , 000 円 に 更新 、 コミット さ れ た 、 もしくは 初期 入金 額 40 , 000 円 で 新規 口座 登録 さ れ た 次郎 が 追加 さ れ て い ます 。 結果 行 に 追加 で 返さ れる 次郎 の データ を ファン トム ( 幻 ： Phantom ） と 呼び ます 。 ノンリピータブルリード 。 同 一 トランザクション 内 で 同じ データ を 複数 回 読み取っ た 場合 、 異なる 結果 を 得る 現象 を ノンリピータブルリード ( Non - Repeatable Read ) と 呼び ます 。 太郎 の 預金 額 は 30 , 000 円 と し ます 。 太郎 の トランザクション は 、 処理 の 中 で 太郎 の 預金 額 の 読み取り を 2 回 行い ます 。 まず 、 太郎 の トランザクション は 、 初回 読み取り を 行い 、 預金 額 30 , 000 円 を 得 ます 。 次に 、 母親 の トランザクション が 、 太郎 の 預金 額 を 読み取り 、 同様 に 30 , 000 円 を 得 、 10 , 000 円 を 加算 し た 40 , 000 円 に 書き換え て コミット し ます 。 この 後 に 、 太郎 の トランザクション が 2 回 目 の 読み取り を 行う と 1 回 目 と は 異なる 金額 40 , 000 円 を 得る こと に なり ます 。 ダーティーリード 。 ある トランザクション が まだ コミット し て い ない 更新 データ を 他 の トランザクション から 読み取る こと を 、 ダーティーリード ( Dirty Read ) と 呼び ます 。 太郎 の 預金 額 は 30 , 000 円 と し ます 。 母親 の トランザクション が 、 太郎 の 預金 額 を 、 30 , 000 円 として 読み取り 、 10 , 000 円 を 加算 し た 40 , 000 円 に 書き換え ます が 、 この 更新 は 未 コミット です 。 ここ で 、 太郎 の トランザクション が 、 未 コミット の 40 , 000 円 を 読み取り ます ( ダーティーリード )。 この まま 、 太郎 の 処理 を 継続 し た 場合 、 どう なる でしょ う か 。 太郎 の トランザクション が 、 10 , 000 円 の 引き出し に 対応 する 処理 を 行う もの で あれ ば 、 読み取っ た 40 , 000 円 から 10 , 000 円 を 減算 し た 30 , 000 円 を 預金 額 として 書き 戻す こと に なり ます 。 しかし 、 もし 、 母親 の 処理 が ロール バック さ れ た 場合 に は 、 未 コミット の 40 , 000 円 を 基 に し た 、 太郎 の トランザクション 処理 は 預金 データ を 不 整合 な もの に し て しまい ます 。 隔離 性 水準 。 DBMS で 同時 実行 制御 を 行う 場合 、 トランザクション の 独立 性 ( Isolation ) の 度合い を 示す 指標 として 「 隔離 性 水準 ( ISOLATION LEVEL )」 が 制定 さ れ て い ます 。 隔離 性 水準 は 分離 レベル と も 呼ば れ ます 。 隔離 性 水準 で は 四つ の 各 水準 で 、 先ほど 学習 し た 、 ファントムリード 、 ノンリピータブルリード 、 ダーティーリード を どこ まで 許容 する か という こと が 定め られ て い ます 。 それぞれ の 水準 で の トランザクション 実行 時 の ふるまい を 以下 に 記載 し ます 。 SERIALIZABLE 。 トランザクション の 直列 実行 を 保証 する 実行 レベル です 。 ファントムリード 、 ノンリピータブルリード 、 ダーティーリード の いずれ も 発生 し ませ ん 。 しかし 、 直列 実行 制御 の ため の オーバー ヘッド により 、 複数 トランザクション を 同時に 実行 し た 場合 に は 、 スループット は 四つ の 水準 の 中 で は 最も 低く なり ます 。 REPEATABLE READ 。 トランザクション 内 で 、 同じ 照会 を 繰り返し て も 、 照会 の 結果 行 が 他 の トランザクション によって 変更 さ れる こと は あり ませ ん 。 しかし 、 新た な 結果 行 を 得る 場合 が あり ます （ ファントムリード が 発生 ） 。 READ COMMITTED 。 他 の トランザクション が 更新 中 の データ を 読み取る こと は あり ませ ん 。 コミット さ れ た データ しか 読み取ら ない という こと です 。 しかし 、 ファントムリード 、 ノンリピータブルリード は 発生 する 可能 性 が あり ます 。 READ UNCOMMITTED 。 他 の トランザクション により コミット さ れる か ロール バック さ れる か わから ない 更新 中 の データ も 読み取り ます 。 四つ の 水準 の 中 で は 、 同時 実行 時 の スループット は 最も 高く なり ます が 、 ダーティーリード 、 ノンリピータブルリード 、 ファントムリード が いずれ も 発生 する 可能 性 が あり ます 。 隔離 性 水準 の 設定 。 ユーザ は 要件 に 応じ 、 DBMS に対して 、 トランザクション の 実行 を 、 これら 四つ の 水準 の うち 、 どれ で 行う か を 指定 し ます 。 複数 の トランザクション を 同時に 実行 さ せ た 時 の スループット は 、 SERIALIZABLE → REPEATBLE READ → READ COMMITTED → READ UNCOMMITTED の 順 に 向上 し て いき ます 。 しかし 、 この 順 に 、 並列 実行 時 の 問題 点 も 多く 発生 する こと に なり ます 。 いずれ の 水準 も ロック を 使用 すれ ば 、 DBMS で の 実装 は 比較的 容易 です 。 例えば 、 データ 更新 時 に は 占有 ロック を かける こと に すれ ば 、 SERIALIZABLE は 、 照会 の 結果 を 得る ため に 読み取る すべて の データ に対して 共有 ロック を かけ 、 トランザクション 完了 まで 保持 する こと で 実現 でき ます 。 また 、 REPEATABLE READ は 、 照会 の 結果 行 に対して 共有 ロック を かけ 、 トランザクション 完了 まで 保持 すれ ば 実現 でき ます 。 READ COMMITTED は データ 読み取り 時 に は 、 対象 データ に 共有 ロック を かけ に いく こと に すれ ば 実現 でき ます 。 READ UNCOMMITTED は データ 読み取り 時 に は 、 対象 データ に ロック を かけ ない こと に すれ ば 実現 でき ます 。 隔離 性 水準 の 実装 は 、 DBMS に 任さ れ て おり 、 四つ の 隔離 性 水準 すべて を サポート し て い ない もの も あり ます 。 また 、 その 設定 方法 も DBMS ごと に 異なり ます が 、 既定 （ デフォルト ） の 水準 として は READ COMMITTED を 採用 し て いる もの が 多く を 占め て い ます 。 標準 SQL ( SQL 92 ) で は 隔離 性 水準 の 設定 を 示す よう に 、 SET TRANSACTION 文 の ISOLATION LEVEL で 四つ の 隔離 性 水準 を 選択 指定 できる よう に なっ て い ます 。 しかし 、 SET TRANSACTION で は なく 、 各 DBMS 固有 の 拡張 SQL で 行う もの も あり ます 。 なお 、 DBMS で は 、 隔離 性 水準 を どの レベル に 設定 し て も ロスト アップデート は 発生 し ませ ん 。 トランザクション 並列 実行 時 、 ダーティーリード 、 ノンリピータブルリード 、 ファントムリード が 発生 する 場合 が ある 。 他 の トランザクション から の 独立 性 の 度合い として 四つ の 隔離 性 水準 が 定め られ て いる 。 隔離 性 水準 の 設定 は SQL で は SET TRANSACTION 文 で 行う 。 
