 SQL 。 SQL の 概要 と SELECT 文 の 基礎 について 学習 し ます 。 SQL 概要 。 SQL は リレーショナル データベース （ RDB ） を 操作 、 定義 する ため の 言語 です 。 SQL は 、 ANSI （ 米国 国家 規格 協会 ） 、 ISO （ 国際 標準 化 機構 ） 、 JIS （ 日本工業規格 ） など によって 標準 化 さ れ て い ます 。 SQL の 大きな 特徴 の 一つ として 、 どの よう な データ が ほしい か だけ を 記述 する 非 手続き 型 言語 で ある 点 が 挙げ られ ます 。 一方 、 C や COBOL 言語 など は 、 どの よう に 処理 を 行う か を 記述 する 手続き 型 言語 に 分類 さ れ ます 。 SQL の 種類 。 各 SQL は 、 JIS X 3005 の 定義 で は データ 操作 言語 （ DML ： Data Manipulation Language ） 、 データ 定義 言語 （ DDL ： Data Definition Language ） に 分け られ ます 。 また 、 分類 によって は GRANT 、 REVOKE 、 ROLLBACK 、 COMMIT を データ 制御 言語 （ DCL ： Data Control Language ） と し て いる もの も あり ます 。 主 な SQL 一覧 。 主 な SQL と 簡単 な 説明 を 記載 し ます 。 詳細 な 説明 は 、 次項 以降 に 記載 し て いき ます 。 SELECT 文 の 基礎 。 表 や ビュー といった オブジェクト から データ を 取り出す に は 、 SELECT 文 を 使用 し ます 。 SELECT 文 の 基本 的 な 構文 は 、 SELECT 句 、 FROM 句 、 WHERE 句 を 組み合わせ た もの です 。 SELECT 文 を 実行 する 上 で 必要 最低限 な もの は 、 SELECT 句 と FROM 句 です 。 関係 演算 の 射影 、 選択 に 相当 する 操作 は 、 出力 列 の 指定 を 行う SELECT 句 、 出力 行 を 抽出 する WHERE 句 です 。 FROM 句 で は 、 表 の 別名 を 定義 でき ます 。 これ により 、 表 の 指定 を 別名 でも 行える よう に なり ます 。 別名 は 、 主 に 表 同士 の 結合 や 相関 副 問合せ で 使用 し ます 。 結合 や 相関 副 問合せ の 詳細 は 、 後続 の テーマ で 説明 し ます 。 次に 、 SELECT 文 の 具体 的 な 実行 例 を 示し ます 。 PRODUCTS 表 に対して SELECT 文 を SELECT 句 、 FROM 句 、 WHERE 句 を 指定 し た 形 で 実行 し て い ます 。 この 時 の SELECT 文 の 実行 順序 は 、 以下 の よう に なり ます 。 ① FROM 句 に 指定 さ れ た 「 PRODUCTS 」 より PRODUCTS 表 が 対象 と なる 。 ② WHERE 句 に 指定 さ れ た 抽出 条件 「 PROD _ CAT = ' 筆記用具 '」 により 、 出力 対象 の 行 は PROD _ CAT 列 の 値 が 筆記用具 の もの のみ と なる 。 ③ SELECT 句 に 指定 さ れ た 「 PROD _ ID , PROD _ NAME 」 より 、 出力 する 列 は PROD _ ID 、 PROD _ NAME と なる 。 SQL で 文字 列 を 指定 する 場合 は 、 「'」（ シングルクオーテーション ） で 囲む 必要 が あり ます 。 また 、 文字 列 や 数値 が 等しい か を 比較 する 記号 は 「 =」 です 。 SELECT 句 で 指定 可能 な もの 。 SELECT 文 内 の SELECT 句 に は 、 表 の 列 名 以外 に も 指定 でき ます 。 これら を 使う こと により 、 単に 列 を 指定 し て 値 を 出力 する だけ で は なく 、 値 を 加工 し て 出力 する こと が でき ます 。 集約 関数 について は 、 別途 、 後続 の テーマ で 詳細 を 記載 し ます 。 また 、 算術 演算 で は 、 NULL と の 演算 結果 は NULL に なる という 点 に 注意 が 必要 です 。 PRODUCTS 表 に SELECT 文 を 実行 し た もの に なり ます 。 SELECT 句 に 指定 し た 「 PROD _ NAME AS 商品 名 」 により 、 PROD _ NAME 列 を 「 商品 名 」 として 出力 し て い ます 。 また 、 「 PROD _ NAME || '（' || PROD _ CAT || '）' AS カテゴリ 付き 商品 名 」 で は 、 PROD _ NAME の 文字 列 、 “ （ ” 、 PROD _ CAT の 文字 列 と “ ） ” を 連結 し て 出力 し て い ます 。 さらに 、 「 PRICE + 10 」 で は 、 PRICE 列 の 数値 に 10 を 加算 し て 「 新 価格 」 という 列 名 で 出力 し て い ます 。 この よう に SELECT 句 で は 、 同じ 列 を 出力 し たり 、 文字 列 の 連結 を 行っ たり する こと も でき ます 。 SQL の 読み方 は 、 日本 で は 「 エスキューエル 」 、 アメリカ など の 海外 で は 「 シーク エル 」 と 読む の が 一般 的 です 。 外国 の 方 が 講師 を 務める セミナー や トレーニング の とき に も 困惑 し ない よう に 「 シーク エル 」 という 呼び 方 も 覚え て き ましょ う 。 データ 操作 は 、 SELECT を 中心 に 書き方 を 覚え 、 実行 結果 を イメージ できる よう に する 。 関係 演算 の 射影 、 選択 に 相当 する SQL の 操作 は 、 SELECT 句 、 WHERE 句 で ある 。 SELECT 句 に は 列 名 だけ で は なく 、 「*」、 集約 関数 、 算術 式 、 '< 文字 列 >'、「||」 など も 指定 できる 。 関数 など 。 この テーマ で は 、 SELECT 句 内 で よく 使用 する 重要 機能 で ある 、 DISTINCT 句 、 COALESCE 関数 、 CASE 式 と 集約 関数 について 学習 し ます 。 SELECT 句 内 で よく 使用 する 重要 機能 。 DISTINCT 句 。 DISTINCT 句 を SELECT 句 の 中 で 使用 する と 、 列 の 重複 値 を 除い た ユニーク な 値 を 出力 でき ます 。 指定 し た 列 が 複数 ある 場合 は 、 列 の 組み合わせ に対して ユニーク な 値 の 組 を 出力 し ます 。 DISTINCT 句 の 対象 に NULL が 含ま れる 場合 、 NULL に対して も 重複 の 排除 を 行い ます 。 PROD _ CAT 列 から ユニーク な 値 を 取得 し て いる SQL です 。 この SQL の 実行 結果 は 、 PROD _ CAT 列 から 重複 する 値 を 除い た 「 筆記用具 」 と 「 書籍 」 が 出力 さ れ ます 。 ② の SQL は 、 PROD _ CAT と COLOR 列 の 組 から ユニーク な 値 を 取得 し て い ます 。 「 筆記用具 、 赤 」 、 「 筆記用具 、 茶 」 、 「 筆記用具 、 赤 」 … という 組 に対して 重複 する 値 を 削除 する ので 、 結果 は 、 「 筆記用具 、 赤 」 、 「 筆記用具 、 茶 」 、 「 書籍 、 青 」 、 「 書籍 、 黒 」 と なり ます 。 COALESCE 関数 。 COALESCE 関数 は 、 指定 さ れ た 引数 に対して 左 から 順に NULL か どう か 評価 を 行い NULL で は ない 値 が あれ ば その 値 を 返し ます 。 また 、 NULL を 任意 の 数値 や 文字 列 に 置き換える こと が でき ます 。 COALESCE 関数 を 使い PRICE 列 の NULL に関して は 数値 「 0 」 に 置き換え て 出力 し た もの です 。 CASE 式 。 CASE 式 を 使う と 、 条件 に 応じ た 分岐 が でき ます 。 CASE 式 は 、 SELECT 句 内 に 記述 し て 、 条件 に 応じ て 出力 する 値 を 変える よう な 使い方 が でき ます 。 PROD _ CAT 列 の 文字 列 を 条件 に 応じ て 他 の 文字 に 置換 し て 出力 し た もの です 。 「 筆記用具 」 は 「 筆 」 に 、 「 書籍 」 は 「 書 」 に 置き換え られ ます 。 「 筆記用具 」 、 「 書籍 」 いずれ も 一致 し ない 文字 列 は 、 ELSE が 適用 さ れ 「 その他 」 に 置き換え られ ます 。 また 、 CASE 式 を カンマ で 区切っ た 後 の PROD _ NAME は 、 通常 の 列 として 扱わ れ ます 。 COALESCE 関数 と CASE 式 は 、 SELECT 句 に 限ら ず WHERE 句 など で も 使用 でき ます 。 集約 関数 。 集約 関数 を 使う と 、 指定 し た 列 の 値 に対して 集計 が でき ます 。 主 な 集約 関数 を 示し ます 。 COUNT は 、 「*」 を 指定 する か 列 を 指定 する か によって NULL に対する 扱い が 異なる こと に 注意 し て ください 。 数値 の 合計 を 求める SUM や AVG など は 、 NULL は 無視 し て 計算 結果 を 出力 し ます 。 COUNT ( DISCTINCT ) を 使い 、 PROD _ CAT 列 の ユニーク な 値 の 件数 を 求め て い ます 。 NULL は 無視 さ れる ため 、 結果 は 「 筆記用具 」 「 書籍 」 「 文房具 」 の ３つ に なり ます 。 SELECT 句 内 で よく 使用 さ れる もの として 、 DISTINCT 句 、 COALESCHE () 関数 、 CASE 式 が ある 。 集計 関数 に は 、 SUM ()、 MAX ()、 MIN ()、 AVG ()、 COUNT ()、 COUNT ( DISTINCT ） が ある 。 COUNT (*) と COUNT (< 列 >） と で は NULL の 扱い が 異なる 点 に 注意 。 述語 。 当 テーマ で は 、 比較 演算 子 や 述語 を 学習 し ます 。 比較 演算 子 。 文字 列 や 数値 の 比較 を 行う 演算 子 を 比較 演算 子 と 呼び ます 。 比較 演算 子 で は 、 NULL を 比較 対象 として 扱え ませ ん 。 NULL を 比較 対象 として 扱う に は 、 学習 する IS NULL 述語 を 使用 し ます 。 比較 演算 子 を 用い た SELECT 文 の 実行 例 を 示し ます 。 WHERE 句 内 で 比較 演算 子 「 <>」 を 使用 し た 例 です 。 WHERE 句 の 条件 「 PROD _ ID <> 101 」 から 、 実行 結果 は 、 PROD _ ID が 101 を 除く 「 鉛筆 」 と 「 消しゴム 」 が 抽出 さ れ ます 。 ② の 例 で は 、 比較 演算 子 「 =」 を 使い NULL と の 比較 を 行っ て い ます 。 比較 演算 子 で は 、 NULL を 比較 対象 として は 扱え ない ため 、 結果 は 1 件 も 出力 さ れ ませ ん 。 NULL と 比較 を 行う に は 、 ③ の よう に IS NULL 述語 を 使用 し ます 。 述語 。 文字 列 や 数値 の 比較 に は 、 比較 演算 子 の 他 に も 述語 も 使用 でき ます 。 述語 は 、 NOT を つける こと により 否定 を とる こと も でき ます 。 また 、 IN 、 BETWEEN 、 LIKE は 、 比較 演算 子 同様 、 NULL を 比較 対象 として 扱い ませ ん 。 EXISTS に関して は 、 相関 副 問合せ で 詳細 を 学習 し ます 。 述語 の 使用 法 を いくつ か の 例 で 示し ます 。 論理 演算 子 。 論理 演算 子 を 使い 、 複数 の 条件 を 組み合わせる こと も でき ます 。 論理 演算 子 は 、 NOT 、 AND 、 OR の 優先 順 で 評価 さ れ ます 。 その ため 、 AND より OR を 先 に 評価 さ せる に は 、 「( )」 を 使用 する 必要 が あり ます 。 AND 、 OR 、 ( ) を 組み合わせ た とき の 実行 結果 を 示し て い ます 。 ( ) 中 の 「 PROD ID = 104 OR PROD _ ID = 101 」 が 先 に 評価 さ れ 、 その後 「 PROD _ CAT = ' 筆記用具 '」 と の AND が 行わ れ ます 。 その 結果 、 PROD _ ID が 101 の 行 が 抽出 さ れ ます 。 もし 、 「 ( )」 を 記述 し なかっ た 場合 は 、 AND の 方 が 先 に 評価 さ れる ため 「 PROD _ ID = 101 AND PROD _ CAT = ' 筆記用具 '」 が 先 に 評価 さ れ 、 次に 「 PROD _ ID = 104 」 と の OR が 実行 さ れ ます 。 これ により 、 PROD _ ID が 101 と 104 の 行 が 抽出 さ れる こと に なり ます 。 比較 演算 子 は 、 <、>、<=、>=、=、<> が ある 。 比較 演算 子 は 、 NULL を 比較 対象 と し ない 。 比較 演算 子 の 他 に も IN 、 BETWEEN 、 LIKE 、 IS NULL 、 EXISTS 述語 も 使用 できる 。 論理 演算 子 として AND 、 OR 、 NOT 、 ( ) が 使用 できる 。 ORDER BY 、 GROUP BY 、 HAVING 。 当 テーマ で は SELECT 文 の ORDER BY 句 、 GROUP BY 句 、 HAVING 句 を 学習 し ます 。 ORDER BY 句 。 SELECT 文 内 で ORDER BY 句 を 使用 する と 、 実行 結果 行 の 並べ 替え が でき ます 。 ORDER BY 句 を 使用 し ない 場合 、 SELECT 文 の 実行 結果 の 並び 順 は 不定 です 。 ここ で の 不定 と は 、 並び 順 に 規則 は なく 、 実行 する 度 に 変わる 可能 性 が ある こと を いい ます 。 その ため 、 SELECT 文 の 実行 結果 を 一定 の 並び 順 で 取得 し たい 場合 は 、 必ず ORDER BY 句 を 指定 する 必要 が あり ます 。 ORDER BY 句 は 、 SELECT 文 の 最後 に 記述 し ます 。 たとえば 、 SELECT 句 ～ WHERE 句 まで の SELECT 文 の 場合 は WHERE 句 の 後 に 、 SELECT 句 ～ HAVING 句 まで の SELECT 文 で あれ ば HAVING 句 の 後 に 記述 し ます 。 なお 、 GROUP BY 句 で 並び 順 で ある ASC （ 昇順 ） および DESC （ 降順 ） を 省略 し た 場合 は 、 昇順 に なり ます 。 ORDER BY 句 の 実行 例 を 示し ます 。 PRICE 列 で 昇順 ソート 行っ た 例 です 。 例 で は 、 昇順 を 示す ASC は 省略 時 の 値 の ため 明示 的 な 指定 は し て い ませ ん 。 一方 、 ② は 、 PRICE 列 で 降順 ソート を 行っ た 例 です 。 ORDER BY 句 の NULL に対する 並び 順 に関する 規定 は あり ませ ん 。 ソート し た 際 、 NULL が 来る 位置 は 、 各 DBMS 製品 によって 異なり ます 。 また 、 ORDERY BY 句 で 指定 する 列 は 、 必ずしも SELECT 句 で 指定 し た 列 で ある 必要 は あり ませ ん 。 先 の 例 で 言え ば 、 SELECT 句 内 に PRICE が なく て も SELECT 文 の 実行 は 可能 です 。 GROUP BY 句 。 GROUP BY 句 を 使用 する と 、 行 の グルーピング が 行え ます 。 これ により 、 集約 関数 は 作成 し た グループ の 単位 で 実行 さ れる よう に なり ます 。 GROUP BY 句 は 、 WHERE 句 の あと に 記述 し ます 。 GROUP BY 句 に 複数 の 列 を 指定 し た 場合 、 指定 さ れ た 列 の 値 の 組み合わせ に対して グルーピング が 行わ れ ます 。 GROUP BY 句 を 使用 時 、 SELECT 句 内 で 指定 する 列 は 、 GROUP BY 句 で 指定 し た 列 を 除い た すべて の 列 に対して 集約 関数 を 用い なけれ ば なり ませ ん 。 GROUP BY 句 の 実行 例 を 示し ます 。 PRODUCTS 表 の PROD _ CAT 列 を GROUP BY 句 に 指定 し た 例 です 。 実行 結果 は 、 PROD _ CAT 列 の 値 で グルーピング 、 集約 さ れ て 「 筆記用具 」 と 「 書籍 」 の 2 件 に なっ て い ます 。 また 、 PRICE の 値 は 、 AVG 関数 によって 、 それぞれ グルーピング 単位 で 平均 値 が 算出 さ れ て い ます 。 ② は 、 GROUP BY 句 に PROD _ ID 列 と ORDER _ DATE 列 を 指定 し た 例 です 。 この 場合 は 、 PROD _ ID 列 の 値 と ORDER _ DATE 列 の 値 と の 組み合わせ で グルーピング 、 集約 さ れ ます 。 HAVING 句 。 HAVING 句 を 使用 する と 、 集計 結果 に対して 条件 による 絞り込み が 行え ます 。 書式 を 示し ます 。 HAVING 句 は 、 GROUP BY 句 の あと に 記述 し ます 。 また 、 HAVING 句 に 記述 する 条件 に は 、 必ず 集約 関数 を 使用 し ます 。 また 、 HAVING 句 は 、 GROUP BY 句 を 指定 し て い なく て も 使用 する こと が でき ます 。 その 場合 は 、 表 全体 を 1 つ の グループ と みなし て 処理 が 行わ れ ます 。 HAVING を 使用 し た 例 を 示し ます 。 HAVING 句 で PRICE 列 の 平均 値 に対して 500 より 大きい 商品 だけ 抽出 し た もの に なり ます 。 HAVING 句 の 前 に GROUP BY 句 が ある ので 、 まず 、 GROUP BY で 指定 さ れ た PROD _ CAT 列 の 値 毎 に グルーピング が 行わ れ ます 。 その後 、 HAVING に 指定 さ れ た 条件 が グループ 単位 で 評価 さ れ ます 。 結果 、 PRICE 列 の 平均 値 が 500 より 大きい 書籍 グループ が 抽出 さ れ ます 。 ORDER BY 句 は 、 SQL の 実行 結果 に対して 並べ 替え を 行う 。 ASC 、 DESC 省略 時 は 、 ASC （ 昇順 ） に なる 。 GROUP BY 句 を 使う こと により 、 集約 関数 による 集計 を GROUP BY 句 で 指定 さ れ た 列 の 値 の グループ 単位 で 行える よう に なる 。 HAVING 句 を 使用 する と 、 集計 結果 に対して 条件 による 絞り込み が 行える 。 
