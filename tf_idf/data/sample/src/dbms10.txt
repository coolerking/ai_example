 記憶 域 の 管理 。 DBMS で 一般 的 に 採用 さ れ て いる 、 記憶 域 の 管理 、 ロギング 、 回復 処理 の 仕組み を 学習 し ます 。 続け て 、 運用 管理 の ポイント を 、 最後 に 分散 データベース について 学習 し ます 。 ぞ れ で は 、 物理 データベース の 記憶 域 構造 から 学習 を 開始 し ましょ う 。 記憶 構造 。 データブロック （ ページ 、 データ ページ ） 。 表 の 行 データ や 索引 データ は 、 示す よう に 、 データベース 内 に は 、 ブロック （ ページ 、 データ ページ ） という 物理 単位 で 格納 さ れ ます 。 ブロック は 、 データベース の 物理 的 な 入出力 の 最小 単位 です 。 一つ の ブロック は 、 ブロック 内 の データ を 管理 する ため の 情報 を 格納 する ヘッダ 部 、 更新 データ を 保管 する ため の 予備 領域 、 行 データ を 格納 する データ 部 で 構成 さ れ て い ます 。 一つ の ブロック の 容量 （ サイズ ） を ブロック サイズ と 呼び ます 。 ブロック は 入出力 の 単位 です から 、 一つ の 行 データ が 複数 ブロック に またがる よう な 状況 が 発生 する と 、 アクセス の パフォーマンス は 低下 し ます 。 なぜ なら ば 、 ある 特定 の 行 データ を 取得 する ため に 、 複数 の ブロック を 物理 的 に 読み取る こと が 必要 に なる から です 。 この ため 、 DBMS によって は 、 一つ の 行 データ が 複数 の ブロック に またがる こと を 許し て い ない もの も あり ます 。 したがって 、 表 の 物理 設計 を 行う 際 に は 、 格納 する 行 データ の サイズ は 、 ブロック サイズ を 超え ない よう に 考慮 し ます 。 使用 できる ブロック サイズ は DBMS により 様々 です 。 固定 サイズ の もの も あれ ば 、 4 , 096 バイト 、 8 , 192 バイト など から 選択 可能 な もの も あり ます 。 データ バッファ 。 SQL 実行 時 、 DBMS は ディスク 上 の データベース から 、 データ を 1 ブロック ずつ 物理 メモリー 内 の データ バッファ 領域 に 読み込ん で 処理 を 行い ます 。 DBMS が ブロック を データ バッファ に 読み込ん で くる 操作 の こと を 、 物理 読み取り 、 物理 読み取り が 発生 し た 回数 を 物理 読み取り 回数 と 呼び ます 。 データ バッファ は データベース の キャッシュ 領域 です 。 したがって 、 その サイズ は データベース の 性能 に 大きな 影響 を 与え ます 。 データベース の 全 データ を データ バッファ に キャッシュ し て おく こと が できれ ば 、 アクセス パフォーマンス は 当然 向上 し ます 。 したがって 、 物理 メモリー 内 に 大きく とれれ ば 、 それ に 越し た こと は あり ませ ん が 、 大き すぎる と 他 の 処理 に 悪影響 を 与え ます 。 場合 によって は DB サーバ が スラッシング 状態 に なっ て しまう こと も あり ます 。 したがって 、 物理 設計 段階 で は 初期 サイズ を 決定 し 、 テスト で 調整 し て いく という 方法 が 一般 的 に 行わ れ ます 。 また 、 サイズ の 自動 調整 機能 を もつ DBMS を 使用 する 場合 は 、 システム テスト の 段階 で 自動 調整 を 活用 し 、 本番 移行 時 に は 自動 調整 の 結果 で サイズ を 固定 する という 方法 も 行わ れ て い ます 。 ブロック サイズ を 選択 可能 な DBMS の 場合 、 どの サイズ に す べき か を 物理 設計 時 に 検討 し ます 。 データ は ブロック の 単位 で データ バッファ に キャッシュ さ れる ため 、 ブロック サイズ は 大きい ほど 、 入出力 の 効率 は 向上 し ます 。 したがって 、 最も 大きな サイズ の もの を 選択 し がち に なり ます が 、 そう 単純 に 考える わけ に も いき ませ ん 。 たとえば 、 処理 し たい データ は 1 行 のみ で ある と し ます 。 データ バッファ に キャッシュ さ れ て いる ブロック に その 行 データ が 格納 さ れ て い ない 場合 に は 、 物理 ディスク から 該当 データ を データ バッファ に 読み取っ て こ なけれ ば なり ませ ん 。 しかし 、 読み取り の 単位 は ブロック です 。 行 データ の サイズ が 小さい 場合 は 、 同じ ブロック 内 に 他 の 行 データ も 多数 含ま れ て い ます 。 この 場合 、 処理 し たい データ は 1 行 のみ な のに 、 処理 に 不要 な 行 データ も キャッシュ し て しまう こと に なり ます 。 したがって 、 大きな ブロック サイズ の 場合 は ブロック 内 に 含ま れる 余分 な データ 量 も 大きく なり 、 その 分 メモリー 領域 が 無駄 と なり ます 。 また 、 複数 の トランザクション を 同時 実行 さ せる 場合 、 ブロック 競合 が 発生 し やすく なり ます 。 したがって 、 データ 処理 の 特性 に 応じ て 、 適切 な ブロック サイズ を 決定 し なけれ ば なり ませ ん 。 一般 的 に は 、 オンライン トランザクション 処理 中心 の 場合 に は 小さな ブロック サイズ 、 集計 分析 処理 中心 の 場合 に は 大きな ブロック サイズ を 選択 し ます 。 バッファ ヒット 率 。 バッファ ヒット 率 と は 、 処理 に 必要 な ブロック が データ バッファ 内 に 存在 し た 割合 です 。 ある 処理 を 行う ため に 必要 な データ が 、 データベース 内 3 ブロック にわたって 格納 さ れ て いる と し ます 。 2 ブロック は 処理 開始 時 、 すでに 他 の 処理 の ため データ バッファ に 既に キャッシュ さ れ て い た と し ます 。 この 場合 、 R で 示す 残り の 1 ブロック を ディスク から 読み取っ て くる ので 、 ヒット 率 は 、 2 ÷ ( 2 ＋ 1 ) × 100 ＝ 67 %　 と なり ます 。 ヒット 率 は 高い ほど 、 効率 的 に 処理 が 行わ れ て いる と 判断 でき ます 。 バッファ ヒット 率 は 、 データベース 性能 評価 の ため の 指標 と なり ます 。 「 ヒット 率 の 目標 は 90 % 以上 」 と やみくも に その 数値 に こだわる こと なく 、 大切 な こと は 「 目標 と する 性能 を 確保 する こと 」 で あり 、 ヒット 率 は 、 その ため の 指標 と とらえ て ください 。 バッファ ヒット 率 を 得る ため の モニタリング ツール も DBMS は 提供 し て い ます が 、 コマンド や 使用 方法 は DBMS ごと に 異なり ます 。 表 領域 （ 表 スペース ） 。 DBMS は 表 や 索引 の ブロック を 格納 する 単位 として 表 領域 （ 表 スペース ） という 概念 を とりいれ て い ます 。 表 領域 は 表 や 索引 を 格納 する ため の 器 です 。 器 の 実体 は OS 上 の ファイル 、 ディレクトリ など 、 使用 する DBMS によって 様々 な 形態 を とり ます 。 表 領域 の 容量 は 、 その 表 領域 に 格納 する 表 の 1 行 当たり の （ 平均 サイズ ） × （ 見積もり 行 数 ） を もと に 算出 し ます 。 忘れ て は いけ ない の は 、 索引 容量 も 容量 見積もり し て おく こと です 。 索引 は DBMS によって 実装 が 異なる ため 、 容量 見積もり は 使用 する DBMS が 提供 する 見積もり 式 を 使用 し ます 。 表 領域 は バックアップ の 単位 と なる 場合 も あり ます 。 物理 設計 時 に は 、 表 領域 に 格納 する 表 、 索引 へ の アクセス 頻度 、 バックアップ 運用 など を 検討 し 、 表 領域 構成 を 決定 後 、 物理 ディスク 上 へ の 適切 な 配置 を 決定 し ます 。 索引 と 表 を 別 の 表 領域 に 分割 可能 な DBMS を 使用 する 場合 に は 、 性能 を 考慮 し て 索引 と 表 を 別 の 表 領域 に 配置 する こと も あり ます 。 さらに 、 表 領域 ごと に データ バッファ を 割り当てる こと が 可能 な DBMS を 使用 する 場合 に は 、 索引 用 の 表 領域 に対して データ バッファ を 優先 的 に 割り当てる こと も 検討 し ます 。 データディクショナリ 。 データベース に どの よう な 表 が 定義 さ れ て いる か 。 表 は 、 どの よう な 列 で 構成 さ れ て いる か 。 索引 は どの 表 の どの 列 に 定義 さ れ て いる か 。 ビュー は どの よう に 定義 さ れ て いる か 。 表 に は 、 どの よう な 制約 が 定義 さ れ て いる か 。 など の スキーマ 定義 情報 を DBMS は データディクショナリ という 領域 に 格納 し ます 。 通常 、 データディクショナリ は 専用 の 独立 し た 表 領域 で 提供 さ れ ます 。 データディクショナリ に は 、 スキーマ 定義 情報 の ほか に 権限 設定 情報 など も 格納 さ れ ます 。 データディクショナリ の 情報 に 直接 アクセス する こと は でき ませ ん が 、 参照 の ため の ビュー が 提供 さ れ て い ます 。 また 、 データディクショナリ の こと を システム カタログ と 呼ぶ 場合 も あり ます 。 データ は ブロック （ ページ 、 データ ページ ） という 物理 単位 に 格納 さ れる 。 バッファ ヒット 率 は 性能 評価 の ため の 一つ の 指標 で ある 。 表 領域 （ 表 スペース ） は ブロック を 管理 する 単位 で ある 。 表 、 索引 、 ビュー など の 定義 情報 は データディクショナリ に 格納 さ れる 。 ロギング 。 ここ で は 、 DBMS が 行う ロギング 、 データブロック 書き込み の 仕組み を 学習 し ます 。 ログ と は 。 DBMS は 、 トランザクション が データベース に対して 行っ た 更新 内容 を すべて ログ として 取得 し ます 。 この ログ 取得 操作 の こと を ロギング と 呼び ます 。 表 に 行 を 挿入 する 場合 に は 、 更新 後 データ を ロギング し ます 。 表 から 行 を 削除 する 場合 に は 更新 前 データ を 、 行 を 更新 する 場合 に は 、 更新 前 データ と 更新 後 データ の 両方 を ロギング し ます 。 また 表 や 索引 の 作成 や 削除 を 行っ た 場合 に も 、 DBMS は その 内容 を ロギング し ます 。 取得 し た ログ は トランザクション や システム に 障害 が 発生 し た 場合 に 実行 する 「 障害 回復 」 （ 次 の 学習 テーマ です ） の ため に 使用 し ます 。 この ため 、 DBMS は 更新 データ だけ で は なく 、 更新 は コミット さ れ た か 、 ロール バック さ れ た か 、 更新 を 行っ た の は どの トランザクション か 、 など 回復 処理 に 必要 と なる トランザクション 情報 も ロギング し ます 。 DBMS が ロギング する 情報 に は 主 に 以下 の よう な もの が あり ます 。 ログ 情報 。 トランザクション 開始 データ （ begin transaction レコード ） 。 更新 前 データ 、 更新 後 データ （ 更新 前 レコード 、 更新 後 レコード ） 。 コミット データ 、 ロールバックデータ （ コミット レコード 、 ロールバックレコード ） トランザクション 終了 データ （ end transaction レコード ） 。 チェックポイント データ （ チェックポイント レコード ） 。 以下 、 トランザクション が 、 ある 表 の 行 データ を 更新 する こと を 例 に 、 ロギング の 仕組み について 学習 を 進め て いき ます 。 ロギング の 仕組み 。 トランザクション が 、 ある 表 の 行 データ の 値 を 101 → 501 に 更新 する 場合 、 DBMS は 、 まず 対象 の データ 101 が 格納 さ れ て いる ブロック を 物理 ディスク 上 の データベース の 表 領域 から 物理 メモリー 上 の データ バッファ 領域 に 読み込ん で き ます 。 この とき 、 対象 の ブロック が 既に データ バッファ に キャッシュ さ れ て いれ ば それ を 使用 し ます 。 次に 、 読み込ん で き た ブロック 内 の 行 データ 101 を データ バッファ 上 で 501 に 更新 し ます 。 また 、 この 更新 の ログ として 更新 前 データ 101 と 更新 後 データ 501 を 、 物理 メモリー 上 の ログ バッファ という 別 の 領域 に 記録 し ます 。 なお 、 複数 の トランザクション が 同時に データ を アクセス する 環境 で は 、 ログ バッファ は 、 すべて の トランザクション 共有 の 資源 と なり ます 。 DBMS は ログ バッファ に 、 複数 の トランザクション による 更新 内容 を 更新 発生 順 に 記録 し て いき ます 。 トランザクション が 更新 を コミット する と 、 DBMS は ログ バッファ に 記録 し た 更新 ログ を 、 物理 ディスク 上 の ログ ファイル に 同期 的 に 書き出し ます 。 データ 101 を 501 に 更新 し て コミット し た 場合 に は 、 ログ バッファ 上 の 更新 前 データ 101 と 更新 後 データ 501 を ログ ファイル に 書き出し ます が 、 その 際 、 トランザクション を コミット し た こと を 記す ため の コミット データ （ コミット レコード ） を 付加 し ます 。 複数 の トランザクション が 同時に 動作 し て いる 環境 で は 、 いずれ か の トランザクション が コミット を 行う と 、 まだ コミット し て い ない トランザクション の 更新 ログ も ログ ファイル に 書き出し ます 。 また 、 ログ バッファ 領域 が 一 杯 に なっ て も ログ ファイル へ の ログ の 書き出し 処理 は 行わ れ ます が 、 ログ バッファ の 使用 率 に 応じ ログ ファイル へ の 書き出し タイミング を 制御 できる パラメータ を 提供 し て いる DBMS も あり ます 。 更新 主体 の 処理 の 場合 、 ログ バッファ の サイズ が 小さ すぎる と 、 頻繁 に ログ ファイル へ の 書き込み 操作 が 発生 する ため 、 全体 の 処理 性能 が 低下 する こと も あり ます 。 この ため 、 物理 設計 、 テスト 時 に は ログ バッファ 領域 の 設定 、 調整 に関する 考慮 も 必要 に なり ます 。 ログ ファイル の 配置 パス 、 個数 、 サイズ は 一般 的 に DBMS の 構成 パラメータ で 設定 、 調整 可能 です が 、 その 既定 値 や 調整 方法 は DBMS ごと に 異なり ます 。 ログ ファイル は 初期 データベース 作成 時 、 複数個 用意 し 、 循環 、 上書き 再 利用 する こと を 既定 の 方式 として 提供 いる もの が 多数 です 。 また 、 更新 前 データ について は 、 ログ バッファ 、 ログ ファイル と は 別 の 領域 に 格納 し 、 トランザクション が コミット する と 削除 し て いく という 方式 を とっ て いる DBMS も あり ます 。 更新 が コミット さ れ て いる か どう か に 関係 なく 、 データ バッファ 上 で 、 その 内容 に 更新 が かかっ た ブロック の こと を 更新 ブロック または 、 ダーティーブロック と 呼ぶ 場合 も あり ます 。 更新 ブロック の 書き込み 。 コミット が 完了 する と ログ は ログ ファイル に は 書か れ て い ます が 、 データ バッファ 上 で 更新 さ れ た ブロック が 、 物理 ディスク 上 の データベース に 書き 戻さ れ て いる 保証 は あり ませ ん 。 コミット 単位 で 、 毎回 更新 ブロック を 物理 ディスク に 書き 戻す 処理 を 行う と 、 入出力 の ため の オーバー ヘッド により データベース 処理 全体 の 性能 が 低下 し て しまい ます 。 この ため 、 DBMS は データ バッファ 上 の 更新 ブロック を 、 コミット と は 別 の タイミング で 書き 戻し ます 。 この 書き 戻し 対象 に は 未 コミット の 更新 ブロック も 含ま れ ます 。 したがって 、 DBMS 稼働 中 は 物理 ディスク 上 の データベース の 表 領域 に は 常時 、 コミット さ れ た 更新 ブロック や 未 コミット の 更新 ブロック が 混在 し た 状態 に なっ て い ます 。 どの よう な タイミング で 更新 ブロック を 書き 戻す か は 、 DBMS によって 相違 が あり ます が 、 主 に は 以下 の よう な 場合 です 。 更新 ブロック の 書き 戻し タイミング 。 ① 新た に ブロック を 読み込ん で くる ため の 空き が 、 データ バッファ 内 に ない 。 ② データ バッファ の 使用 量 が あらかじめ 設定 し た 閾値 を 超え た 。 ③ チェックポイント が 発生 し た 。 チェックポイント 。 DBMS が 定期 的 に データ バッファ 上 の すべて の 更新 ブロック を コミット 、 未 コミット に 関わら ず 、 一括 し て データベース に 書き 戻す 処理 の こと を チェックポイント と いい ます 。 チェックポイント 実行 時 、 DBMS は 、 その 時点 で 実行 中 の トランザクション の 一覧 を 、 チェックポイント データ （ チェックポイント レコード ） として ロギング し ます 。 データ 101 → 501 へ の 更新 を コミット し て も 、 501 の データ は データベース に 書き 戻さ れ ませ ん が 、 チェックポイント で は 必ず 書き 戻さ れ ます 。 チェックポイント 時 、 別 の トランザクション が データ 700 を 800 に 更新 し て まだ コミット し て い なかっ た 場合 に は 、 未 コミット の 800 の データ を データベース に 書き 戻し ます 。 また 、 同時に 800 の 更新 を 実行 中 の トランザクション 情報 を 、 チェックポイント レコード として ロギング し ます 。 DBMS は 次 の テーマ で 学習 する 「 障害 回復 」 を 実行 する とき に 、 ロギング さ れ た チェックポイント レコード を 参照 し ます 。 チェックポイント は 、 実行 中 の トランザクション 処理 を 一旦 中断 し て 、 コミット 、 未 コミット に 関わら ず 、 データ バッファ 上 の 更新 ブロック を すべて 物理 ディスク に 書き込む 処理 を 行う ため 、 サーバ に 非常 に 負荷 の かかる 処理 です 。 その ため 、 実際 の 多く の DBMS で は 、 その 実行 制御 を 構成 パラメータ で 指定 できる よう に し て い ます 。 頻繁 に チェックポイント を 実行 する よう に 構成 する と 、 通常 時 の 入出力 頻度 は 高まり ます が 、 障害 から の 回復 処理 に かかる 時間 は 短縮 でき ます 。 逆 に 、 チェックポイント の 間隔 を 長く 設定 する と 、 通常 時 の 入出力 頻度 は 減少 し ます が 、 一 回 の チェックポイント で の システム 負荷 が 高まり ます 。 また 、 障害 から の 回復 時間 が 長く なり ます 。 したがって 、 物理 設計 、 テスト 時 に は 、 チェックポイント 間隔 の 検討 、 調整 も 必要 です 。 ログ は データベース に対する すべて の 更新 作業 の 記録 で ある 。 DBMS は ログ を もと に データベース の 回復 処理 を 行う 。 ログ は メモリー 上 の ログ バッファ という 領域 に 書か れ 、 コミット 操作 により ログ ファイル に 同期 的 に 書か れる が 、 データ バッファ 上 の 更新 ブロック は コミット と は 別 の タイミング で データベース に 書き 戻さ れる 。 チェックポイント と は データ バッファ 上 の すべて の 更新 ブロック を データベース に 書き込む 動作 で ある 。 障害 回復 。 ログ や チェックポイント について 学習 し まし た が 、 ここ で は 引き続き これら を 利用 し た 回復 処理 について 学習 を 進め ます 。 WAL プロトコル 。 DBMS は 障害 から の 復旧 時 、 ログ ファイル に 記録 さ れ た ログ を 使用 し て データベース の 回復 処理 を 行い ます 。 コミット し た 更新 データ を 含む ブロック が 物理 ディスク に 書き 戻さ れる 前 に 、 DB サーバ が 電源 断 や 、 サーバ OS の 異常 など 、 何らかの 原因 で 突然 システム ダウン し た と し ます 。 この 場合 、 DBMS は 再 起動 時 、 ログ ファイル に 記録 し た チェックポイント データ 、 更新 前 データ 、 更新 後 データ 、 コミット データ を もと に 物理 ディスク 上 の データベース の 回復 処理 を 行い ます 。 回復 処理 の 中 で 、 コミット し た トランザクション による 更新 内容 は データベース に 反映 し 、 未 コミット の トランザクション による 更新 内容 は データベース から 取り除き ます 。 ログ を もと に し た 障害 回復 機能 を 実現 する ため に は DBMS は WAL プロトコル （ Write Ahead Log Protocol ） を 守る 必要 が あり ます 。 この 規約 は 、 「 データ バッファ 上 の 更新 ブロック を データベース へ 書き込む 際 に は 、 その 更新 ログ は 、 先 に ログ ファイル に 書き込み を 完了 し て いる こと 」 を 要求 する もの です 。 この 規約 を 守ら なけれ ば ログ を 使用 し た 回復 処理 は 行え なく なっ て しまい ます 。 以下 、 この 規約 の 必要 性 を 学習 し ます 。 ある トランザクション が 、 ある 表 の 行 データ 201 を 301 に 更新 し ます （ 未 コミット ） 。 この 場合 、 DBMS は 、 更新 前 データ 201 と 、 更新 後 データ 301 を 更新 ログ として ログ バッファ に 記録 し ます 。 次に 、 ログ バッファ 上 の 更新 ログ を ログ ファイル に 書く より 前 に 、 データ バッファ 上 の 更新 ブロック を 未 コミット の まま ディスク 上 の データベース に 書き 戻し た と し ます 。 ここ で DB サーバ が システム ダウン し たら どう なる でしょ う か 。 ディスク 上 の データベース に は 未 コミット の データ 301 が 保存 さ れ て い ます が 、 ログ バッファ 内 に 保持 さ れ て い た 更新 前 データ 201 は 障害 とともに 消え て しまい ます 。 この 場合 、 ログ を もと に し た 回復 処理 を 実行 でき なく なっ て しまい ます 。 この よう な 状況 を 発生 さ せ ない ため 、 データ バッファ 上 の 更新 ブロック と ログ バッファ 上 の 更新 ログ の どちら を 先 に ディスク に 書き出す か について の 規約 として WAL プロトコル が あり ます 。 この 規約 に 従え ば 、 更新 ブロック 書き込み 時 に は 、 ① まず 、 ログ バッファ 内 の 更新 ログ を ログ ファイル に 書き込み 。 ② その後 、 データ バッファ の 更新 ブロック を 書き込む 。 という 手順 で 操作 を 行う こと に なり ます 。 この 場合 に は 、 電源 断 など で 物理 メモリー の 内容 が 失わ れ て も 、 ログ ファイル に 記録 し た 更新 ログ から データベース を 障害 前 の 状態 に 回復 する こと が 可能 に なり ます 。 したがって 、 更新 ブロック 書き込み の 際 に は 、 チェックポイント で 書き込む 場合 に も DBMS は WAL プロトコル に もとづき 、 先 に 書き込み 対象 の 更新 ブロック に対する 更新 ログ を ログ ファイル に 書き込み を 完了 し て おか ね ば なり ませ ん 。 前進 復帰 、 後退 復帰 。 ロギング し た 更新 前 データ を もと に DBMS が 行う 回復 処理 の こと を 後退 復帰 （ ロールバック 、 UNDO ） 、 更新 後 レコード を もと に 行う 回復 処理 の こと を 前進 復帰 （ ロールフォワード 、 REDO ） と いい ます 。 ここ で は 、 これら の 回復 処理 について 学習 し ます 。 なお 、 時間 は 左 から 右 へ 経過 し て いき ます 。 T 1 , T 2 , T 3 は トランザクション 、 ○ は トランザクション の 開始 、 ● は トランザクション が コミット し て 終了 する こと を 表現 し て い ます 。 また 、 チェックポイント は 時刻 tc で 発生 し 、 時刻 td で 障害 により DB サーバ が システム ダウン し た と 想定 し て い ます 。 DBMS は 再 起動 時 、 ログ ファイル に 記録 さ れ て いる チェックポイント レコード の トランザクション リスト 、 コミット データ 、 更新 前 データ 、 更新 後 データ を もと に 、 以下 の よう な 回復 処理 を 実行 し ます 。 T 1 の 処理 。 T 1 は 、 チェックポイント 発生 前 に 処理 を 開始 し 、 システム ダウン が 発生 する 前 に 処理 を コミット し て 終了 し て い ます 。 T 1 が チェックポイント まで に 行っ た 更新 は チェックポイント により 物理 ディスク 上 の データベース に 書き込ま れ て い ます 。 したがって 、 チェックポイント 以降 、 T 1 が コミット し て 終了 し た 時点 まで 前進 復帰 し ます 。 T 2 の 処理 。 T 2 は 、 システム ダウン 発生 時 まだ 実行 中 です 。 テーマ 040 で 学習 し た よう に データベース へ の 書き込み は チェックポイント だけ で 発生 する わけ で は あり ませ ん 。 T 2 が チェックポイント 以降 に 行っ た 未 コミット の 更新 は データベース に 書き込ま れ て いる こと も あり 得 ます 。 したがって 、 システム ダウン 直前 から T 2 が 開始 し た 時点 まで 後退 復帰 し ます 。 T 3 の 処理 。 T 3 は 、 チェックポイント 以降 に 処理 を 開始 し て い ます 。 したがって 、 T 3 が 開始 し た 時点 から コミット し て 終了 し た 時点 まで 前進 復帰 し ます 。 なお 、 時刻 tc の チェックポイント より も 前 に 処理 を 終了 し て いる トランザクション について は 、 チェックポイント により 、 その 更新 内容 が 物理 ディスク 上 の データベース に 反映 さ れる こと が 保証 さ れる ため 、 回復 処理 の 必要 は あり ませ ん 。 障害 回復 の 種類 。 データベース で 発生 する 障害 は トランザクション 障害 、 システム 障害 、 媒体 障害 の 3 つ に 大別 でき ます 。 DBMS は 、 いずれ の 障害 に対して も 、 ログ を 利用 し て 回復 処理 を 行い ます 。 トランザクション 障害 。 個々 の トランザクション が 実行 中 に 何らかの 要因 により 、 異常 終了 する こと を 、 トランザクション 障害 と いい ます 。 処理 実行 中 に ゼロ 除算 が 発生 、 制約 違反 が 発生 、 管理 コマンド により 強制 終了 が かかっ た 、 あるいは デッドロック が 発生 し た 場合 など が これ に 相当 し ます 。 この 場合 、 DBMS は ロギング し た 更新 前 データ を 使用 し て 後退 復帰 を 行い ます 。 後退 復帰 により 、 異常 終了 し た トランザクション の 未 コミット 更新 データ を データベース から 取り除き 、 ACID の 原子 性 （ Atomicity ） を 実現 し て い ます 。 システム 障害 。 突然 の 電源 断 や 、 OS の 障害 、 DBMS の 障害 、 あるいは それら の 障害 から の 回復 の 過程 で 、 物理 メモリー が 初期 化 さ れ て しまい 、 データ バッファ や ログ バッファ の 更新 データ を 失っ て しまう 状況 を システム 障害 と いい ます 。 システム 障害 が 発生 し た 場合 DBMS は 、 再 起動 時 、 未 コミット の データ が データベース に 書き込ま れ て いる 場合 に は 、 後退 復帰 し ます 。 また 、 コミット 済 の データ が まだ データベース に 書き込ま れ て い なかっ た 場合 は 前進 復帰 し 、 ACID の 耐久 性 ( Durability ) を 実現 し て い ます 。 媒体 障害 。 データベース を 配置 し て いる 物理 ディスク 領域 が 損傷 し て しまう こと を 媒体 障害 と いい ます 。 この 場合 は 、 事前 に 取得 し て おい た データベース の バックアップ を リストア し バックアップ 取得 以降 の ログ を 利用 し て 障害 発生 前 まで の 前進 復帰 を 行い ます 。 回復 の ため の コマンド や 、 その 実行 手順 は 使用 する DBMS 固有 の もの と なり ます 。 WAL プロトコル は 、 データ が 更新 さ れ た 場合 に は ログ を 必ず 先 に 書く という 規約 で ある 。 後退 復帰 （ ロールバック ） は ログ に 書か れ た 更新 前 情報 を 、 前進 復帰 （ ロールフォワード ） は 更新 後 情報 を 使用 し て データベース の 回復 処理 を 行う 。 データベース で 発生 する 障害 は トランザクション 障害 、 システム 障害 、 媒体 障害 の 3 つ に 大別 できる が 、 DBMS は 、 いずれ の 障害 に対して も 、 ログ を 利用 し て 回復 処理 を 行う 。 
